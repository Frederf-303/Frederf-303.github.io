<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Gesture AR 3D Editor</title>
<style>
:root {
  --bg: #0b0b10;
  --panel-bg: rgba(20, 20, 30, 0.95);
  --panel-bg-hover: rgba(30, 30, 45, 0.98);
  --border: rgba(255, 255, 255, 0.1);
  --accent: #5ddcff;
  --text: #ffffff;
  --text-muted: #9aa0aa;
  --danger: #ff5555;
  --success: #4CAF50;
  --warning: #ff9800;
  --info: #2196F3;
  --radius: 12px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* –ö–∞–º–µ—Ä–∞ */
#camera {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  z-index: 0;
}

/* Canvas Three.js */
canvas {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  z-index: 1;
  pointer-events: none;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–æ–Ω–∞ */
#backgroundContainer {
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;
}

/* –ü–∞–Ω–µ–ª–∏ - —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
.panel {
  position: fixed;
  top: 0;
  height: 100%;
  width: 280px;
  background: var(--panel-bg);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border);
  padding: 20px;
  z-index: 2;
  transition: var(--transition);
  overflow-y: auto;
  overflow-x: hidden;
}

.panel::-webkit-scrollbar {
  width: 6px;
}

.panel::-webkit-scrollbar-track {
  background: transparent;
}

.panel::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
}

/* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
#leftPanel {
  left: -260px;
  border-right: none;
  border-radius: 0 var(--radius) var(--radius) 0;
}

#leftPanel:hover,
#leftPanel.visible {
  left: 0;
  box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
  background: var(--panel-bg-hover);
}

/* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å */
#rightPanel {
  right: -260px;
  border-left: none;
  border-radius: var(--radius) 0 0 var(--radius);
}

#rightPanel:hover,
#rightPanel.visible {
  right: 0;
  box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
  background: var(--panel-bg-hover);
}

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ–∫—Ü–∏–π */
.section-title {
  font-size: 14px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--accent);
  margin: 25px 0 15px;
  padding-bottom: 8px;
  border-bottom: 2px solid rgba(93, 220, 255, 0.2);
}

.section-title:first-child {
  margin-top: 0;
}

/* –ì—Ä—É–ø–ø—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
.button-group {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 20px;
}

/* –ö–Ω–æ–ø–∫–∏ */
.btn {
  background: rgba(255, 255, 255, 0.07);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 12px 16px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  user-select: none;
}

.btn:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.btn:active {
  transform: translateY(0);
}

.btn.active {
  background: rgba(93, 220, 255, 0.15);
  border-color: var(--accent);
  color: var(--accent);
  box-shadow: 0 0 20px rgba(93, 220, 255, 0.2);
}

.btn.danger {
  background: rgba(255, 85, 85, 0.1);
  border-color: var(--danger);
  color: var(--danger);
}

.btn.danger:hover {
  background: rgba(255, 85, 85, 0.2);
}

.btn.success {
  background: rgba(76, 175, 80, 0.1);
  border-color: var(--success);
  color: var(--success);
}

.btn.wide {
  grid-column: span 2;
  margin-top: 5px;
}

/* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
.input-group {
  margin-bottom: 15px;
}

.label {
  display: block;
  margin-bottom: 8px;
  font-size: 13px;
  color: var(--text-muted);
  font-weight: 500;
}

.color-input {
  width: 100%;
  height: 40px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: transparent;
}

.color-input::-webkit-color-swatch-wrapper {
  padding: 0;
}

.color-input::-webkit-color-swatch {
  border: 2px solid var(--border);
  border-radius: 6px;
}

.range-input {
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: rgba(255, 255, 255, 0.1);
  outline: none;
  -webkit-appearance: none; /* –£–¥–∞–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ –¥–ª—è WebKit –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
  -moz-appearance: none;    /* –£–¥–∞–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ –¥–ª—è Firefox */
  appearance: none;         /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ */
}

.range-input::-webkit-slider-thumb {
  -webkit-appearance: none; /* –£–¥–∞–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥ –ø–æ–ª–∑—É–Ω–∫–∞ –¥–ª—è WebKit */
  appearance: none;         /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ */
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid var(--bg);
  box-shadow: 0 0 10px rgba(93, 220, 255, 0.5);
}

.range-input::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid var(--bg);
  box-shadow: 0 0 10px rgba(93, 220, 255, 0.5);
}

.range-value {
  display: inline-block;
  min-width: 40px;
  text-align: right;
  font-size: 13px;
  color: var(--accent);
  font-weight: 600;
}

/* –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ */
.objects-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 500px;
  overflow-y: auto;
  margin-bottom: 20px;
}

.object-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 15px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  transition: var(--transition);
}

.object-item:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateX(5px);
}

.object-item.active {
  background: rgba(93, 220, 255, 0.15);
  border-color: var(--accent);
}

.object-color {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
}

.object-name {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
}

.object-type {
  font-size: 12px;
  color: var(--text-muted);
  background: rgba(255, 255, 255, 0.1);
  padding: 2px 8px;
  border-radius: 10px;
}

.delete-object {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 18px;
  cursor: pointer;
  padding: 0 5px;
  transition: var(--transition);
}

.delete-object:hover {
  color: var(--danger);
  transform: scale(1.2);
}

/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ —Ä–µ–∂–∏–º–æ–≤ –≤–Ω–∏–∑—É */
.mode-zones {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 100px;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0;
  z-index: 2;
  pointer-events: none;
}

.mode-zone {
  height: 100%;
  position: relative;
  transition: var(--transition);
  pointer-events: auto;
  border-top: 4px solid transparent;
}

.mode-zone.active {
  border-top-color: currentColor;
  background: linear-gradient(to top, rgba(255, 255, 255, 0.1), transparent);
}

.mode-zone:hover {
  background: linear-gradient(to top, rgba(255, 255, 255, 0.15), transparent);
}

.mode-label {
  position: absolute;
  bottom: 15px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  opacity: 0.9;
  transition: var(--transition);
  pointer-events: none;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
}

.mode-zone:hover .mode-label {
  bottom: 20px;
  opacity: 1;
}

/* –¶–≤–µ—Ç–∞ –∑–æ–Ω */
.zone-movexy {
  color: #FF0202;
  background: linear-gradient(to top, rgba(255, 2, 2, 0.2), transparent);
}

.zone-movez {
  color: #EEFF05;
  background: linear-gradient(to top, rgba(238, 255, 5, 0.2), transparent);
}

.zone-rotate {
  color: #00FF21;
  background: linear-gradient(to top, rgba(0, 255, 33, 0.2), transparent);
}

.zone-scale {
  color: #1900FF;
  background: linear-gradient(to top, rgba(25, 0, 255, 0.2), transparent);
}

/* –ö—É—Ä—Å–æ—Ä —â–∏–ø–∫–∞ */
#pinchCursor {
  position: fixed;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  pointer-events: none;
  z-index: 3;
  transition: transform 0.05s ease-out, background-color 0.1s ease, left 0.05s ease, top 0.05s ease;
  transform: translate(-50%, -50%) scale(1);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 14px;
  border: 3px solid currentColor;
  box-shadow: 0 0 25px currentColor;
  opacity: 0;
}

#pinchCursor.visible {
  opacity: 1;
}

/* –¶–≤–µ—Ç–∞ –∫—É—Ä—Å–æ—Ä–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ */
.cursor-movexy {
  background: rgba(255, 2, 2, 0.4);
  color: #FF0202;
}

.cursor-movez {
  background: rgba(238, 255, 5, 0.4);
  color: #EEFF05;
}

.cursor-rotate {
  background: rgba(0, 255, 33, 0.4);
  color: #00FF21;
}

.cursor-scale {
  background: rgba(25, 0, 255, 0.4);
  color: #1900FF;
}

.cursor-draw {
  background: rgba(255, 0, 0, 0.4);
  color: #ff0000;
}

.cursor-fist {
  background: rgba(93, 220, 255, 0.6);
  color: #5ddcff;
  box-shadow: 0 0 30px rgba(93, 220, 255, 0.8);
}

/* –ò–∫–æ–Ω–∫–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ) */
.icon {
  display: inline-block;
  width: 18px;
  height: 18px;
  background-size: contain;
  background-repeat: no-repeat;
  opacity: 0.8;
}

.icon-home { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z'/%3E%3C/svg%3E"); }
.icon-2d { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z'/%3E%3C/svg%3E"); }
.icon-brush { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34c-.39-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.02 0-1.41z'/%3E%3C/svg%3E"); }
.icon-camera { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z'/%3E%3C/svg%3E"); }
.icon-export { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z'/%3E%3C/svg%3E"); }
.icon-delete { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z'/%3E%3C/svg%3E"); }

/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å */
.toggle-switch {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
}

.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255, 255, 255, 0.1);
  transition: var(--transition);
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: var(--transition);
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--accent);
}

input:checked + .slider:before {
  transform: translateX(26px);
}

/* –°–∫—Ä—ã—Ç—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∑–æ–Ω */
.zone-button {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
.mode-indicator {
  position: absolute;
  top: 30%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 24px;
  font-weight: bold;
  opacity: 0.3;
  pointer-events: none;
  transition: var(--transition);
}

.mode-zone:hover .mode-indicator {
  opacity: 0.5;
  transform: translate(-50%, -50%) scale(1.2);
}

/* –°—á–µ—Ç—á–∏–∫ –æ–±—ä–µ–∫—Ç–æ–≤ */
.objects-counter {
  display: inline-block;
  background: var(--accent);
  color: var(--bg);
  font-size: 12px;
  font-weight: bold;
  padding: 2px 8px;
  border-radius: 10px;
  margin-left: 8px;
}

/* –°—Ç–∞—Ç—É—Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è */
#handStatus {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.7);
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  z-index: 4;
  display: none;
}

.hand-detected {
  color: #4CAF50;
}

.hand-not-detected {
  color: #ff9800;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫—É–ª–∞–∫–∞ */
#fistIndicator {
  position: fixed;
  top: 50px;
  right: 10px;
  background: rgba(93, 220, 255, 0.2);
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  z-index: 4;
  display: none;
  border: 1px solid rgba(93, 220, 255, 0.5);
}

/* –î–û–ë–ê–í–¨–¢–ï –í –ö–û–ù–ï–¶ CSS-–ë–õ–û–ö–ê */

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
.btn.highlighted {
  background: rgba(93, 220, 255, 0.3) !important;
  border-color: var(--accent) !important;
  box-shadow: 
    0 0 20px rgba(93, 220, 255, 0.5),
    inset 0 0 0 2px rgba(255, 255, 255, 0.5) !important;
  transform: translateY(-2px) scale(1.05) !important;
  z-index: 100;
}

.object-item.highlighted {
  background: rgba(93, 220, 255, 0.25) !important;
  border-color: var(--accent) !important;
  box-shadow: 0 0 15px rgba(93, 220, 255, 0.4) !important;
}

.color-input.highlighted {
  box-shadow: 0 0 0 3px var(--accent) !important;
}

.range-input.highlighted::-webkit-slider-thumb {
  box-shadow: 0 0 15px rgba(93, 220, 255, 0.8) !important;
  transform: scale(1.3);
}

.switch.highlighted .slider {
  box-shadow: 0 0 10px var(--accent) !important;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–∫–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
#clickModeIndicator {
  position: fixed;
  bottom: 120px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(93, 220, 255, 0.9);
  backdrop-filter: blur(10px);
  padding: 10px 20px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  z-index: 1000;
  display: none;
  border: 2px solid rgba(255, 255, 255, 0.9);
  color: #000;
  box-shadow: 0 5px 25px rgba(93, 220, 255, 0.3);
  animation: slideUp 0.3s ease-out;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –∫–ª–∏–∫–∞ */
.click-feedback {
  position: fixed;
  pointer-events: none;
  z-index: 999;
  animation: clickPulse 0.4s ease-out;
  border-radius: 50%;
}

@keyframes clickPulse {
  0% {
    transform: scale(0.5);
    opacity: 0.8;
  }
  100% {
    transform: scale(2);
    opacity: 0;
  }
}

/* –î–û–ë–ê–í–¨–¢–ï –í –ö–û–ù–ï–¶ CSS-–ë–õ–û–ö–ê */

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
.btn.highlighted {
  background: rgba(93, 220, 255, 0.3) !important;
  border-color: var(--accent) !important;
  box-shadow: 
    0 0 20px rgba(93, 220, 255, 0.5),
    inset 0 0 0 2px rgba(255, 255, 255, 0.5) !important;
  transform: translateY(-2px) scale(1.05) !important;
  z-index: 100;
}

.object-item.highlighted {
  background: rgba(93, 220, 255, 0.25) !important;
  border-color: var(--accent) !important;
  box-shadow: 0 0 15px rgba(93, 220, 255, 0.4) !important;
}

.color-input.highlighted {
  box-shadow: 0 0 0 3px var(--accent) !important;
}

.range-input.highlighted::-webkit-slider-thumb {
  box-shadow: 0 0 15px rgba(93, 220, 255, 0.8) !important;
  transform: scale(1.3);
}

.switch.highlighted .slider {
  box-shadow: 0 0 10px var(--accent) !important;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–∫–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
#clickModeIndicator {
  position: fixed;
  bottom: 120px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(93, 220, 255, 0.9);
  backdrop-filter: blur(10px);
  padding: 10px 20px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  z-index: 1000;
  display: none;
  border: 2px solid rgba(255, 255, 255, 0.9);
  color: #000;
  box-shadow: 0 5px 25px rgba(93, 220, 255, 0.3);
  animation: slideUp 0.3s ease-out;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –∫–ª–∏–∫–∞ */
.click-feedback {
  position: fixed;
  pointer-events: none;
  z-index: 999;
  animation: clickPulse 0.4s ease-out;
  border-radius: 50%;
}

@keyframes clickPulse {
  0% {
    transform: scale(0.5);
    opacity: 0.8;
  }
  100% {
    transform: scale(2);
    opacity: 0;
  }
}

</style>
</head>
<body>

<video id="camera" autoplay playsinline muted></video>
<div id="backgroundContainer"></div>
<div id="pinchCursor"></div>
<div id="handStatus"></div>
<div id="fistIndicator"></div>

<!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è) -->
<div id="leftPanel" class="panel">
  <div class="section-title">
    <span class="icon icon-home"></span>
    –ù–∞–≤–∏–≥–∞—Ü–∏—è
  </div>
  <div class="button-group">
    <button class="btn wide" onclick="location.href='2D.html'">
      <span class="icon icon-2d"></span>
      –ü–µ—Ä–µ–π—Ç–∏ –≤ 2D
    </button>
  </div>

  <div class="section-title">
    <span class="icon icon-brush"></span>
    –§–∏–≥—É—Ä—ã
  </div>
  <div class="button-group">
    <button class="btn" onclick="addShape('cube')">–ö—É–±</button>
    <button class="btn" onclick="addShape('sphere')">–°—Ñ–µ—Ä–∞</button>
    <button class="btn" onclick="addShape('cylinder')">–¶–∏–ª–∏–Ω–¥—Ä</button>
    <button class="btn" onclick="addShape('pyramid')">–ü–∏—Ä–∞–º–∏–¥–∞</button>
    <button class="btn wide" onclick="startDrawing()" id="btn-draw">
      <span class="icon icon-brush"></span>
      –ö–∏—Å—Ç—å (3D)
    </button>
  </div>

  <div class="section-title">
    –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∏—Å—Ç–∏
  </div>
  <div class="input-group">
    <label class="label">–¶–≤–µ—Ç –∫–∏—Å—Ç–∏</label>
    <input type="color" id="brushColorPicker" value="#ff0000" class="color-input">
  </div>
  <div class="input-group">
    <label class="label">–¢–æ–ª—â–∏–Ω–∞: <span id="brushWidthValue" class="range-value">0.2</span></label>
    <input type="range" id="brushWidthPicker" min="0.1" max="1.0" step="0.05" value="0.2" class="range-input">
  </div>

  <div class="section-title">
    <span class="icon icon-camera"></span>
    –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã
  </div>
  <div class="button-group">
    <button class="btn" id="btn-mirror" style="display: none;">–û—Ç–∑–µ—Ä–∫–∞–ª–∏—Ç—å</button>
    <button class="btn active" id="btn-camera">–í–∫–ª –∫–∞–º–µ—Ä—É</button>
  </div>
  <div class="toggle-switch">
    <span class="label">–¶–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω</span>
    <label class="switch">
      <input type="checkbox" id="colorBgToggle">
      <span class="slider"></span>
    </label>
  </div>
  <div class="input-group" id="bgColorContainer" style="display: none;">
    <label class="label">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
    <input type="color" id="bgColorPicker" value="#1a1a2e" class="color-input">
  </div>

  <div class="section-title">
    –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
  </div>
  <div class="input-group">
    <label class="label">–£—Ä–æ–≤–µ–Ω—å: <span id="smoothnessValue" class="range-value">0.4</span></label>
    <input type="range" id="smoothnessPicker" min="0.1" max="0.9" step="0.05" value="0.4" class="range-input">
  </div>

  <div class="section-title">
    <span class="icon icon-export"></span>
    –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç
  </div>
  <div class="button-group">
    <button class="btn" onclick="saveWithBackground()">PNG —Å —Ñ–æ–Ω–æ–º</button>
    <button class="btn" onclick="saveTransparent()">PNG –±–µ–∑ —Ñ–æ–Ω–∞</button>
    <button class="btn" onclick="saveWithColorBg()">PNG —Å —Ü–≤–µ—Ç–Ω—ã–º —Ñ–æ–Ω–æ–º</button>
    <button class="btn" onclick="loadBackgroundImage()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω</button>
  </div>

  <div class="section-title">
    <span class="icon icon-delete"></span>
    –î–µ–π—Å—Ç–≤–∏—è
  </div>
  <div class="button-group">
    <button class="btn danger" onclick="deleteActive()">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
    <button class="btn danger wide" onclick="clearScene()">–û—á–∏—Å—Ç–∏—Ç—å —Å—Ü–µ–Ω—É</button>
  </div>
</div>

<!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è) -->
<div id="rightPanel" class="panel">
  <div class="section-title">
    –û–±—ä–µ–∫—Ç—ã <span id="objectsCount" class="objects-counter">0</span>
  </div>
  <div class="objects-list" id="objectsList">
    <!-- –û–±—ä–µ–∫—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
  </div>
</div>

<div id="clickModeIndicator" style="display: none;">–†–µ–∂–∏–º –∫–ª–∏–∫–æ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</div>

<!-- –ó–æ–Ω—ã —Ä–µ–∂–∏–º–æ–≤ –≤–Ω–∏–∑—É -->
<div class="mode-zones">
  <div class="mode-zone zone-movexy" id="zoneMoveXY">
    <button class="zone-button" onclick="setMode('movexy')"></button>
    <div class="mode-indicator">XY</div>
    <div class="mode-label">–î–≤–∏–≥–∞—Ç—å XY</div>
  </div>
  
  <div class="mode-zone zone-movez" id="zoneMoveZ">
    <button class="zone-button" onclick="setMode('movez')"></button>
    <div class="mode-indicator">Z</div>
    <div class="mode-label">–î–≤–∏–≥–∞—Ç—å Z</div>
  </div>
  
  <div class="mode-zone zone-rotate" id="zoneRotate">
    <button class="zone-button" onclick="setMode('rotate')"></button>
    <div class="mode-indicator">‚Üª</div>
    <div class="mode-label">–ö—Ä—É—Ç–∏—Ç—å</div>
  </div>
  
  <div class="mode-zone zone-scale" id="zoneScale">
    <button class="zone-button" onclick="setMode('scale')"></button>
    <div class="mode-indicator">‚áÖ</div>
    <div class="mode-label">–†–∞–∑–º–µ—Ä</div>
  </div>
</div>





<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js";
import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8";

/* –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø */
const video = document.getElementById("camera");
const pinchCursor = document.getElementById("pinchCursor");
const handStatus = document.getElementById("handStatus");
const fistIndicator = document.getElementById("fistIndicator");

let videoStream = null;
let cameraEnabled = true;

/* –°–û–°–¢–û–Ø–ù–ò–ï –î–õ–Ø –ö–õ–ò–ö–û–í */
let clickDetectionState = {
  enabled: false,          // –í–∫–ª—é—á–µ–Ω –ª–∏ —Ä–µ–∂–∏–º –∫–ª–∏–∫–æ–≤
  active: false,           // –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ —Å–µ–π—á–∞—Å –∫–ª–∏–∫
  startTime: 0,            // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —â–µ–ø–∫–∞
  element: null,           // –≠–ª–µ–º–µ–Ω—Ç –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
  lastElement: null,       // –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
  clickThreshold: 500,     // –ü–æ—Ä–æ–≥ –¥–ª—è –∫–ª–∏–∫–∞ (–º—Å)
  minPinchTime: 100        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —â–µ–ø–∫–∞ –¥–ª—è –∫–ª–∏–∫–∞
};

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã */
async function initCamera() {
  try {
    videoStream = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'user',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      } 
    });
    video.srcObject = videoStream;
    await video.play();
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
    cameraEnabled = false;
    video.style.display = 'none';
  }
}

/* THREE.JS –°–¶–ï–ù–ê */
const scene = new THREE.Scene();
scene.background = null;

const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
camera.position.z = 4;

const renderer = new THREE.WebGLRenderer({ 
  alpha: true, 
  antialias: true, 
  preserveDrawingBuffer: true 
});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
document.body.appendChild(renderer.domElement);

/* –û—Å–≤–µ—â–µ–Ω–∏–µ */
scene.add(new THREE.AmbientLight(0xffffff, 0.6));

const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
mainLight.position.set(2, 3, 5);
scene.add(mainLight);

const backLight = new THREE.DirectionalLight(0xffffff, 0.4);
backLight.position.set(-2, -1, -3);
scene.add(backLight);

/* –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø */
let objects = [];
let activeObject = null;
let currentMode = 'movexy'; // movexy, movez, rotate, scale, draw
let isDrawing = false;
let currentTube = null;
let tubePoints = [];

/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª—è–º–∏ */
let isFistDetected = false;
let panelsVisible = false;

/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∏—Å—Ç–∏ */
const brushSettings = {
  color: "#ff0000",
  width: 0.2
};

/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è */
const smoothingSettings = {
  positionSmoothness: 0.4,
  smoothedPosition: new THREE.Vector3(0, 0, 0),
  smoothedCursor: { x: 0.5, y: 0.5 } // –ù–∞—á–∏–Ω–∞–µ–º —Å —Ü–µ–Ω—Ç—Ä–∞ —ç–∫—Ä–∞–Ω–∞
};

/* –¶–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω */
let useColorBackground = false;
let backgroundColor = "#1a1a2e";
let customBackground = null;

/* –ó–æ–Ω—ã —Ä–µ–∂–∏–º–æ–≤ */
const modeZones = {};

/* –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è —Å —É—Å–∫–æ—Ä–µ–Ω–∏–µ–º */
function exponentialSmoothingFast(current, previous, alpha) {
  // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
  return previous * (1 - alpha) + current * (alpha);
}

/* –°–æ–∑–¥–∞–Ω–∏–µ 3D-—Ç—Ä—É–±–∫–∏ */
function createTubeFromPoints(points, color, width) {
  if (points.length < 2) return null;
  
  const curve = new THREE.CatmullRomCurve3(points);
  const tubeGeometry = new THREE.TubeGeometry(
    curve,
    Math.max(20, points.length * 2),
    width,
    8,
    false
  );
  
  const material = new THREE.MeshStandardMaterial({ 
    color: color,
    roughness: 0.3,
    metalness: 0.1
  });
  
  const tube = new THREE.Mesh(tubeGeometry, material);
  tube.userData = { type: 'tube', color, width, points };
  return tube;
}

/* –°–æ–∑–¥–∞–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö —Ñ–∏–≥—É—Ä */
function createMesh(type, color) {
  const material = new THREE.MeshStandardMaterial({ 
    color: color,
    roughness: 0.3,
    metalness: 0.1
  });
  
  switch(type) {
    case "cube":
      return new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), material);
    case "sphere":
      return new THREE.Mesh(new THREE.SphereGeometry(0.5, 32, 32), material);
    case "cylinder":
      return new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 0.8, 32), material);
    case "pyramid":
      return new THREE.Mesh(new THREE.ConeGeometry(0.5, 0.9, 4), material);
    default:
      return null;
  }
}

/* –°–û–°–¢–û–Ø–ù–ò–ï –î–õ–Ø –ü–ê–ù–ï–õ–ï–ô */
let panelsManuallyVisible = false; // –§–ª–∞–≥ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª—è–º–∏

/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª—è–º–∏ */
function showPanels() {
    if (!panelsVisible) {
        document.getElementById('leftPanel').classList.add('visible');
        document.getElementById('rightPanel').classList.add('visible');
        panelsVisible = true;
        panelsManuallyVisible = true; // –ü–∞–Ω–µ–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –≤—Ä—É—á–Ω—É—é
    }
}

function hidePanels() {
    if (panelsVisible) {
        document.getElementById('leftPanel').classList.remove('visible');
        document.getElementById('rightPanel').classList.remove('visible');
        panelsVisible = false;
        panelsManuallyVisible = false; // –ü–∞–Ω–µ–ª–∏ –∑–∞–∫—Ä—ã—Ç—ã
    }
}

/* –ù–û–í–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞–Ω–µ–ª–µ–π –∫—É–ª–∞–∫–æ–º */
function togglePanelsWithFist(isFistNow) {
    if (isFistNow && !isFistDetected) {
        // –ö—É–ª–∞–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–µ–π
        if (panelsManuallyVisible) {
            // –ï—Å–ª–∏ –ø–∞–Ω–µ–ª–∏ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã - —Å–∫—Ä—ã–≤–∞–µ–º –∏—Ö
            hidePanels();
            // –í—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∫–ª–∏–∫–æ–≤
            toggleClickMode(false);
        } else {
            // –ï—Å–ª–∏ –ø–∞–Ω–µ–ª–∏ –±—ã–ª–∏ —Å–∫—Ä—ã—Ç—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
            showPanels();
            // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∫–ª–∏–∫–æ–≤
            toggleClickMode(true);
        }
        
        isFistDetected = true;
        fistIndicator.textContent = '–ö—É–ª–∞–∫: –ø–∞–Ω–µ–ª–∏ ' + (panelsManuallyVisible ? '–ø–æ–∫–∞–∑–∞–Ω—ã' : '—Å–∫—Ä—ã—Ç—ã');
        fistIndicator.style.display = 'block';
        updateCursorForFist();
        
    } else if (!isFistNow && isFistDetected) {
        // –ö—É–ª–∞–∫ —Ä–∞–∑–∂–∞—Ç - —Ç–æ–ª—å–∫–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è
        isFistDetected = false;
        fistIndicator.style.display = 'none';
        
        // –ù–ï —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª–∏ –∏ –ù–ï –≤—ã–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∫–ª–∏–∫–æ–≤!
        // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä
        updateCursorColor();
    }
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –¥–ª—è –∫—É–ª–∞–∫–∞ */
function updateCursorForFist() {
    pinchCursor.classList.remove('cursor-movexy', 'cursor-movez', 'cursor-rotate', 'cursor-scale', 'cursor-draw');
    pinchCursor.classList.add('cursor-fist');
    pinchCursor.textContent = panelsManuallyVisible ? 'üëä‚Üí' : '‚Üíüëä'; // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è
}

/* UI –§–£–ù–ö–¶–ò–ò */
window.addShape = (type) => {
  const color = document.getElementById("brushColorPicker").value;
  const mesh = createMesh(type, color);
  if (!mesh) return;
  
  mesh.position.set(0, 0, -1.5);
  scene.add(mesh);
  
  const obj = {
    mesh,
    type,
    name: `${getTypeName(type)} ${objects.length + 1}`,
    id: Date.now() + Math.random()
  };
  
  objects.push(obj);
  setActive(obj);
  updateObjectsList();
};

function getTypeName(type) {
  const names = {
    cube: '–ö—É–±',
    sphere: '–°—Ñ–µ—Ä–∞',
    cylinder: '–¶–∏–ª–∏–Ω–¥—Ä',
    pyramid: '–ü–∏—Ä–∞–º–∏–¥–∞',
    tube: '–õ–∏–Ω–∏—è'
  };
  return names[type] || type;
}

window.startDrawing = () => {
  setMode('draw');
  document.getElementById('btn-draw').classList.add('active');
};

window.setMode = (mode) => {
  currentMode = mode;
  isDrawing = (mode === 'draw');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–æ–Ω
  const zoneElements = {
    movexy: document.getElementById('zoneMoveXY'),
    movez: document.getElementById('zoneMoveZ'),
    rotate: document.getElementById('zoneRotate'),
    scale: document.getElementById('zoneScale')
  };
  
  Object.entries(zoneElements).forEach(([zoneMode, element]) => {
    if (element) {
      if (zoneMode === mode) {
        element.classList.add('active');
      } else {
        element.classList.remove('active');
      }
    }
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –∫—É—Ä—Å–æ—Ä–∞
  updateCursorColor();
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
  document.querySelectorAll('.btn.active').forEach(btn => btn.classList.remove('active'));
  
  if (mode === 'draw') {
    document.getElementById('btn-draw').classList.add('active');
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
  handStatus.textContent = `–†–µ–∂–∏–º: ${getModeName(mode)}`;
  handStatus.style.display = 'block';
  handStatus.className = 'hand-detected';
};

function getModeName(mode) {
  const names = {
    movexy: '–î–≤–∏–≥–∞—Ç—å XY',
    movez: '–î–≤–∏–≥–∞—Ç—å Z',
    rotate: '–ö—Ä—É—Ç–∏—Ç—å',
    scale: '–†–∞–∑–º–µ—Ä',
    draw: '–†–∏—Å–æ–≤–∞–Ω–∏–µ'
  };
  return names[mode] || mode;
}

function updateCursorColor() {
  pinchCursor.className = '';
  
  if (currentMode === 'draw') {
    pinchCursor.classList.add('cursor-draw');
    pinchCursor.textContent = '‚úèÔ∏è';
  } else {
    pinchCursor.classList.add('cursor-' + currentMode);
    const labels = {
      movexy: 'XY',
      movez: 'Z',
      rotate: '‚Üª',
      scale: '‚áÖ'
    };
    pinchCursor.textContent = labels[currentMode] || '';
  }
  pinchCursor.classList.add('visible');
}

window.deleteActive = () => {
  if (!activeObject) return;
  
  scene.remove(activeObject.mesh);
  objects = objects.filter(o => o !== activeObject);
  activeObject = objects.length > 0 ? objects[objects.length - 1] : null;
  
  if (activeObject && activeObject.mesh.material) {
    document.getElementById("brushColorPicker").value = 
      "#" + activeObject.mesh.material.color.getHexString();
  }
  
  updateObjectsList();
};

window.clearScene = () => {
  if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é —Å—Ü–µ–Ω—É?")) return;
  
  objects.forEach(obj => scene.remove(obj.mesh));
  objects = [];
  activeObject = null;
  updateObjectsList();
};

function setActive(obj) {
  activeObject = obj;
  updateObjectsList();
  
  if (obj && obj.mesh.material) {
    const hexColor = obj.mesh.material.color.getHexString();
    document.getElementById("brushColorPicker").value = "#" + hexColor;
  }
}

function updateObjectsList() {
  const list = document.getElementById("objectsList");
  const counter = document.getElementById("objectsCount");
  
  list.innerHTML = '';
  counter.textContent = objects.length;
  
  objects.forEach((obj, index) => {
    const color = obj.mesh.material.color;
    const hexColor = "#" + color.getHexString();
    
    const item = document.createElement("div");
    item.className = "object-item" + (obj === activeObject ? " active" : "");
    item.innerHTML = `
      <div class="object-color" style="background:${hexColor}"></div>
      <span class="object-name">${obj.name}</span>
      <span class="object-type">${getTypeName(obj.type)}</span>
      <button class="delete-object" onclick="deleteObject(${index})">√ó</button>
    `;
    
    item.onclick = () => setActive(obj);
    list.appendChild(item);
  });
}

window.deleteObject = (index) => {
  if (index >= 0 && index < objects.length) {
    scene.remove(objects[index].mesh);
    objects.splice(index, 1);
    
    if (objects.length > 0) {
      setActive(objects[objects.length - 1]);
    } else {
      activeObject = null;
      updateObjectsList();
    }
  }
};

/* –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò UI */
document.getElementById("brushColorPicker").addEventListener("input", (e) => {
  brushSettings.color = e.target.value;
  
  if (activeObject && activeObject.mesh.material) {
    activeObject.mesh.material.color.set(e.target.value);
    updateObjectsList();
  }
});

document.getElementById("brushWidthPicker").addEventListener("input", (e) => {
  brushSettings.width = parseFloat(e.target.value);
  document.getElementById("brushWidthValue").textContent = brushSettings.width.toFixed(2);
});

document.getElementById("smoothnessPicker").addEventListener("input", (e) => {
  smoothingSettings.positionSmoothness = parseFloat(e.target.value);
  document.getElementById("smoothnessValue").textContent = smoothingSettings.positionSmoothness.toFixed(2);
});

document.getElementById("colorBgToggle").addEventListener("change", (e) => {
  useColorBackground = e.target.checked;
  document.getElementById("bgColorContainer").style.display = useColorBackground ? "block" : "none";
  
  if (useColorBackground) {
    scene.background = new THREE.Color(backgroundColor);
    if (customBackground) {
      scene.background = null;
    }
  } else {
    scene.background = null;
  }
});

document.getElementById("bgColorPicker").addEventListener("input", (e) => {
  backgroundColor = e.target.value;
  if (useColorBackground && !customBackground) {
    scene.background = new THREE.Color(backgroundColor);
  }
});

document.getElementById("btn-camera").addEventListener("click", function() {
  cameraEnabled = !cameraEnabled;
  this.classList.toggle("active");
  video.style.opacity = cameraEnabled ? "1" : "0.3";
});

/* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–∞ */
window.loadBackgroundImage = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        const texture = new THREE.TextureLoader().load(event.target.result);
        texture.mapping = THREE.EquirectangularReflectionMapping;
        scene.background = texture;
        customBackground = texture;
        useColorBackground = false;
        document.getElementById("colorBgToggle").checked = false;
        document.getElementById("bgColorContainer").style.display = "none";
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  };
  
  input.click();
};

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–æ–Ω —Ä–µ–∂–∏–º–æ–≤ */
function initModeZones() {
  const zoneIds = ['zoneMoveXY', 'zoneMoveZ', 'zoneRotate', 'zoneScale'];
  
  zoneIds.forEach(zoneId => {
    const element = document.getElementById(zoneId);
    if (element) {
      const mode = zoneId.replace('zone', '').toLowerCase();
      modeZones[mode] = {
        element: element,
        rect: null
      };
      updateZoneRect(mode);
    }
  });
  
  // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–∑–µ—Ä–∫–∞–ª–∏–≤–∞–Ω–∏—è
  document.getElementById('btn-mirror').style.display = 'none';
}

/* –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–õ–ò–ö–û–í –ñ–ï–°–¢–ê–ú–ò */

// –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∫–ª–∏–∫–æ–≤
function toggleClickMode(enable) {
  clickDetectionState.enabled = enable;
  
  const indicator = document.getElementById('clickModeIndicator');
  if (!indicator) {
    const newIndicator = document.createElement('div');
    newIndicator.id = 'clickModeIndicator';
    newIndicator.textContent = '–†–µ–∂–∏–º –∫–ª–∏–∫–æ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω';
    document.body.appendChild(newIndicator);
  }
  
  if (enable) {
    document.getElementById('clickModeIndicator').style.display = 'block';
    setTimeout(() => {
      document.getElementById('clickModeIndicator').style.display = 'none';
    }, 3000);
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
function getElementAtPosition(x, y) {
  const screenX = x * window.innerWidth;
  const screenY = y * window.innerHeight;
  
  // –°–∫—Ä—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –Ω–∞ –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏
  const cursor = document.getElementById('pinchCursor');
  const originalDisplay = cursor.style.display;
  cursor.style.display = 'none';
  
  // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
  const element = document.elementFromPoint(screenX, screenY);
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä
  cursor.style.display = originalDisplay || '';
  
  return element;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º
function isClickableElement(element) {
  if (!element) return false;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–≥–∏
  const clickableTags = ['BUTTON', 'INPUT', 'SELECT', 'A'];
  if (clickableTags.includes(element.tagName)) {
    return true;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∞—Å—Å—ã
  const clickableClasses = [
    'btn', 'object-item', 'color-input', 'range-input', 
    'toggle-switch', 'switch', 'slider', 'zone-button'
  ];
  
  for (const className of clickableClasses) {
    if (element.classList.contains(className)) {
      return true;
    }
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª–µ–π
  let parent = element.parentElement;
  while (parent) {
    if (parent.classList && Array.from(parent.classList)
        .some(c => clickableClasses.includes(c))) {
      return true;
    }
    parent = parent.parentElement;
  }
  
  return false;
}

// –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
function highlightElement(element, highlight = true) {
  if (!element) return;
  
  // –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
  let clickableElement = element;
  
  // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π, –∏—â–µ–º —Ä–æ–¥–∏—Ç–µ–ª—è
  if (!isClickableElement(element)) {
    clickableElement = element.closest(
      '.btn, .object-item, .color-input, .range-input, .switch, .slider, .zone-button'
    );
  }
  
  if (!clickableElement) return;
  
  // –°–Ω–∏–º–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
  if (clickDetectionState.lastElement && 
      clickDetectionState.lastElement !== clickableElement) {
    clickDetectionState.lastElement.classList.remove('highlighted');
  }
  
  if (highlight) {
    clickableElement.classList.add('highlighted');
    clickDetectionState.lastElement = clickableElement;
  } else {
    clickableElement.classList.remove('highlighted');
    clickDetectionState.lastElement = null;
  }
}

// –≠—Ñ—Ñ–µ–∫—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
function showClickFeedback(x, y) {
  const feedback = document.createElement('div');
  feedback.className = 'click-feedback';
  feedback.style.position = 'fixed';
  feedback.style.left = x * 100 + '%';
  feedback.style.top = y * 100 + '%';
  feedback.style.width = '50px';
  feedback.style.height = '50px';
  feedback.style.background = 'radial-gradient(circle, rgba(93, 220, 255, 0.6) 0%, transparent 70%)';
  feedback.style.transform = 'translate(-50%, -50%)';
  
  document.body.appendChild(feedback);
  
  setTimeout(() => {
    feedback.remove();
  }, 400);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É
function handleElementClick(element, cursorX, cursorY) {
  if (!element) return;
  
  console.log('–ö–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É:', element);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
  showClickFeedback(cursorX, cursorY);
  
  // –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
  let clickableElement = element;
  if (!isClickableElement(element)) {
    clickableElement = element.closest(
      '.btn, .object-item, .color-input, .range-input, .switch, .slider, .zone-button'
    );
  }
  
  if (!clickableElement) return;
  
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  if (clickableElement.tagName === 'BUTTON') {
    // –ö–Ω–æ–ø–∫–∏
    clickableElement.click();
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
    const originalBg = clickableElement.style.background;
    clickableElement.style.background = 'rgba(93, 220, 255, 0.4)';
    
    setTimeout(() => {
      clickableElement.style.background = originalBg;
      clickableElement.classList.remove('highlighted');
    }, 200);
    
  } else if (clickableElement.type === 'range') {
    // –°–ª–∞–π–¥–µ—Ä—ã
    const rect = clickableElement.getBoundingClientRect();
    const relativeX = (cursorX * window.innerWidth - rect.left) / rect.width;
    const value = Math.max(0, Math.min(1, relativeX));
    const min = parseFloat(clickableElement.min) || 0;
    const max = parseFloat(clickableElement.max) || 100;
    
    const newValue = min + value * (max - min);
    clickableElement.value = newValue;
    
    // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏—è
    clickableElement.dispatchEvent(new Event('input', { bubbles: true }));
    clickableElement.dispatchEvent(new Event('change', { bubbles: true }));
    
  } else if (clickableElement.type === 'color') {
    // –¶–≤–µ—Ç–æ–≤—ã–µ –ø–∏–∫–µ—Ä—ã
    clickableElement.click();
    
  } else if (clickableElement.classList.contains('object-item')) {
    // –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
    clickableElement.click();
    
  } else if (clickableElement.classList.contains('switch')) {
    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏
    const checkbox = clickableElement.querySelector('input[type="checkbox"]');
    if (checkbox) {
      checkbox.checked = !checkbox.checked;
      checkbox.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }
}
//–≤–∞–≥—É—Ä–∏ –∫–∞–æ—Ä–æ–∫—É —Ö–∑ –∑–∞—á–µ–º, –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫, —è –∂–µ –µ–±–ª–∞–Ω –º–Ω–µ –º–æ–∂–Ω–æ, —Ç–∏–ø–æ –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
function updateZoneRect(mode) {
  if (modeZones[mode] && modeZones[mode].element) {
    modeZones[mode].rect = modeZones[mode].element.getBoundingClientRect();
  }
}

/* –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–æ–Ω—ã –ø–æ –ø–æ–∑–∏—Ü–∏–∏ —Ä—É–∫–∏ */
function getZoneFromPosition(x, y) {
  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø–∏–∫—Å–µ–ª–∏
  const screenX = x * window.innerWidth;
  const screenY = y * window.innerHeight;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∑–æ–Ω
  Object.keys(modeZones).forEach(mode => updateZoneRect(mode));
  
  // –ë–µ–∑ –¥–µ–±–∞–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:
  for (const [mode, zone] of Object.entries(modeZones)) {
    if (zone.rect) {
      const inZone = screenX >= zone.rect.left && 
                     screenX <= zone.rect.right &&
                     screenY >= zone.rect.top && 
                     screenY <= zone.rect.bottom;
      
      if (inZone) {
        return mode;
      }
    }
  }
  
  return null;
}

/* –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É–ª–∞–∫–∞ */
function isFistGesture(landmarks) {
  if (!landmarks || landmarks.length === 0) return false;
  
  const lm = landmarks[0];
  
  // –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏
  const wrist = lm[0];       // –ó–∞–ø—è—Å—Ç—å–µ
  const thumbTip = lm[4];    // –ö–æ–Ω—á–∏–∫ –±–æ–ª—å—à–æ–≥–æ –ø–∞–ª—å—Ü–∞
  const indexTip = lm[8];    // –ö–æ–Ω—á–∏–∫ —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞–ª—å—Ü–∞
  const middleTip = lm[12];  // –ö–æ–Ω—á–∏–∫ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø–∞–ª—å—Ü–∞
  const ringTip = lm[16];    // –ö–æ–Ω—á–∏–∫ –±–µ–∑—ã–º—è–Ω–Ω–æ–≥–æ –ø–∞–ª—å—Ü–∞
  const pinkyTip = lm[20];   // –ö–æ–Ω—á–∏–∫ –º–∏–∑–∏–Ω—Ü–∞
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∂–∞—Ç—ã –ª–∏ –ø–∞–ª—å—Ü—ã (–∫–æ–Ω—á–∏–∫–∏ –±–ª–∏–∑–∫–æ –∫ –∑–∞–ø—è—Å—Ç—å—é)
  const maxFistDistance = 0.15; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∫—É–ª–∞–∫–∞
  
  const thumbDistance = Math.hypot(thumbTip.x - wrist.x, thumbTip.y - wrist.y);
  const indexDistance = Math.hypot(indexTip.x - wrist.x, indexTip.y - wrist.y);
  const middleDistance = Math.hypot(middleTip.x - wrist.x, middleTip.y - wrist.y);
  const ringDistance = Math.hypot(ringTip.x - wrist.x, ringTip.y - wrist.y);
  const pinkyDistance = Math.hypot(pinkyTip.x - wrist.x, pinkyTip.y - wrist.y);
  
  // –ö—É–ª–∞–∫, –∫–æ–≥–¥–∞ –≤—Å–µ –ø–∞–ª—å—Ü—ã –±–ª–∏–∑–∫–æ –∫ –∑–∞–ø—è—Å—Ç—å—é
  const isFist = thumbDistance < maxFistDistance &&
                 indexDistance < maxFistDistance &&
                 middleDistance < maxFistDistance &&
                 ringDistance < maxFistDistance &&
                 pinkyDistance < maxFistDistance;
  
  return isFist;
}

/* MEDIAPIPE –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –†–£–ö */
let handLandmarker = null;
let handDetectionActive = true;
let lastHandDetectionTime = 0;
let lastCursorUpdateTime = 0;
const CURSOR_UPDATE_INTERVAL = 16; // ~60 FPS

async function initHandDetection() {
  try {
    const vision = await FilesetResolver.forVisionTasks(
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/wasm"
    );
    
    handLandmarker = await HandLandmarker.createFromOptions(vision, {
      baseOptions: { 
        modelAssetPath: "https://storage.googleapis.com/mediapipe-assets/hand_landmarker.task" 
      },
      runningMode: "VIDEO", 
      numHands: 1,
      minHandDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    
    startHandLoop();
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä—É–∫:", err);
  }
}

const PINCH_THRESHOLD = 0.08;
let isPinching = false;
let transformStart = null;
let zoneCheckCooldown = 0;

/* –£—Å–∫–æ—Ä–µ–Ω–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ */
function getSmoothedCursorPosition(rawX, rawY) {
  // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã
  if (smoothingSettings.smoothedCursor.x === 0 && smoothingSettings.smoothedCursor.y === 0) {
    smoothingSettings.smoothedCursor.x = rawX;
    smoothingSettings.smoothedCursor.y = rawY;
    return { x: rawX, y: rawY };
  }
  
  // –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
  const alpha = 0.8; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
  smoothingSettings.smoothedCursor.x = exponentialSmoothingFast(
    rawX,
    smoothingSettings.smoothedCursor.x,
    alpha
  );
  smoothingSettings.smoothedCursor.y = exponentialSmoothingFast(
    rawY,
    smoothingSettings.smoothedCursor.y,
    alpha
  );
  
  return { x: smoothingSettings.smoothedCursor.x, y: smoothingSettings.smoothedCursor.y };
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ */
function updateCursorPosition(screenX, screenY, scale = 1.2) {
  const now = Date.now();
  
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞
  if (now - lastCursorUpdateTime < CURSOR_UPDATE_INTERVAL) {
    return;
  }
  
  lastCursorUpdateTime = now;
  
  // –ï–¥–∏–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
  pinchCursor.style.left = (screenX * 100) + "%";
  pinchCursor.style.top = (screenY * 100) + "%";
  pinchCursor.style.transform = `translate(-50%, -50%) scale(${scale})`;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä
  if (!pinchCursor.classList.contains('visible')) {
    pinchCursor.classList.add('visible');
  }
}

/* –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä—É–∫–∏ */
function handleHandLandmarks(landmarks) {
  if (!landmarks || landmarks.length === 0) {
    const now = Date.now();
    if (now - lastHandDetectionTime > 2000) { // 2 —Å–µ–∫—É–Ω–¥—ã –±–µ–∑ —Ä—É–∫–∏
      handStatus.textContent = '–†—É–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞';
      handStatus.className = 'hand-not-detected';
      fistIndicator.style.display = 'none';
      pinchCursor.classList.remove('visible');
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–∫–æ–≤
      if (clickDetectionState.element) {
        highlightElement(clickDetectionState.element, false);
        clickDetectionState.element = null;
      }
    }
    return;
  }
  
  lastHandDetectionTime = Date.now();
  const lm = landmarks[0];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∂–µ—Å—Ç –∫—É–ª–∞–∫–∞
  const isFistNow = isFistGesture(landmarks);
  if (isFistNow !== isFistDetected) {
      togglePanelsWithFist(isFistNow);
  }
  
  // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –∫—É—Ä—Å–æ—Ä–∞
  const thumb = lm[4];
  const index = lm[8];
  const cursorX = (thumb.x + index.x) / 2;
  const cursorY = (thumb.y + index.y) / 2;
  
  // –°–≥–ª–∞–∂–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
  const smoothedCursor = getSmoothedCursorPosition(cursorX, cursorY);
  
  // –ï—Å–ª–∏ —Ä–µ–∂–∏–º –∫—É–ª–∞–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω
  if (isFistNow) {
    updateCursorPosition(smoothedCursor.x, smoothedCursor.y, 1.5);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫—É—Ä—Å–æ—Ä–∞
    pinchCursor.textContent = panelsManuallyVisible ? 'üëä‚Üí' : '‚Üíüëä';
    
    // –í —Ä–µ–∂–∏–º–µ –∫—É–ª–∞–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
    if (panelsManuallyVisible && clickDetectionState.enabled) {
        const element = getElementAtPosition(smoothedCursor.x, smoothedCursor.y);
        if (element && isClickableElement(element)) {
            highlightElement(element, true);
            clickDetectionState.element = element;
        } else if (clickDetectionState.element) {
            highlightElement(clickDetectionState.element, false);
            clickDetectionState.element = null;
        }
    }
    return;
  }
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —â–µ–ø–æ–∫
  const pinchDistance = Math.hypot(thumb.x - index.x, thumb.y - index.y);
  const isPinchNow = pinchDistance < PINCH_THRESHOLD;
  
  // –ï—Å–ª–∏ –ø–∞–Ω–µ–ª–∏ –≤–∏–¥–Ω—ã –∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –∫–ª–∏–∫–æ–≤
  if (clickDetectionState.enabled && panelsVisible) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
    const element = getElementAtPosition(smoothedCursor.x, smoothedCursor.y);
    
    if (element && isClickableElement(element)) {
      // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
      highlightElement(element, true);
      clickDetectionState.element = element;
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —â–µ–ø–∫–∞ –¥–ª—è –∫–ª–∏–∫–∞
      if (isPinchNow && !clickDetectionState.active) {
        // –ù–∞—á–∞–ª–æ —â–µ–ø–∫–∞ –Ω–∞–¥ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
        clickDetectionState.active = true;
        clickDetectionState.startTime = Date.now();
        
      } else if (!isPinchNow && clickDetectionState.active) {
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —â–µ–ø–∫–∞
        const pinchDuration = Date.now() - clickDetectionState.startTime;
        
        // –ï—Å–ª–∏ —â–µ–ø–æ–∫ –±—ã–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–º (–Ω–µ —Å–ª—É—á–∞–π–Ω—ã–π)
        if (pinchDuration >= clickDetectionState.minPinchTime && 
            pinchDuration < clickDetectionState.clickThreshold) {
          // –≠—Ç–æ –∫–ª–∏–∫!
          handleElementClick(element, smoothedCursor.x, smoothedCursor.y);
        }
        
        clickDetectionState.active = false;
        clickDetectionState.startTime = 0;
      }
    } else {
      // –ö—É—Ä—Å–æ—Ä –Ω–µ –Ω–∞–¥ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
      if (clickDetectionState.element) {
        highlightElement(clickDetectionState.element, false);
        clickDetectionState.element = null;
      }
      
      if (isPinchNow && clickDetectionState.active) {
        // –©–µ–ø–æ–∫ –Ω–∞—á–∞–ª—Å—è –Ω–∞–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–º, –Ω–æ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –≤–Ω–µ –µ–≥–æ
        clickDetectionState.active = false;
        clickDetectionState.startTime = 0;
      }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
    updateCursorPosition(smoothedCursor.x, smoothedCursor.y, isPinchNow ? 1.8 : 1.2);
    
    // –í —Ä–µ–∂–∏–º–µ –∫–ª–∏–∫–æ–≤ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∏—Å–æ–≤–∞–Ω–∏–µ/—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é
    return;
  }
  
  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–∫–æ–≥–¥–∞ –ø–∞–Ω–µ–ª–∏ —Å–∫—Ä—ã—Ç—ã –∏–ª–∏ —Ä–µ–∂–∏–º –∫–ª–∏–∫–æ–≤ –≤—ã–∫–ª—é—á–µ–Ω)
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–æ–Ω—É –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
  if (!isPinchNow && !isPinching) {
    zoneCheckCooldown++;
    if (zoneCheckCooldown >= 5) {
      zoneCheckCooldown = 0;
      const hoveredZone = getZoneFromPosition(cursorX, cursorY);
      
      if (hoveredZone && hoveredZone !== currentMode && currentMode !== 'draw') {
        setMode(hoveredZone);
      }
    }
  }
  
  // –ê–Ω–∏–º–∞—Ü–∏—è —â–∏–ø–∫–∞
  if (isPinchNow) {
    updateCursorPosition(smoothedCursor.x, smoothedCursor.y, 1.8);
    
    const worldPos = getWorldPositionFromFingers(thumb, index, -1.5);
    
    if (currentMode === 'draw') {
      handleDrawing(worldPos, !isPinching);
    } else if (activeObject) {
      handleObjectTransform(worldPos, !isPinching);
    }
    
    isPinching = true;
  } else {
    updateCursorPosition(smoothedCursor.x, smoothedCursor.y, 1.2);
    
    if (isPinching) {
      if (currentMode === 'draw' && currentTube) {
        finishDrawing();
      }
      isPinching = false;
      transformStart = null;
    }
  }
}

/* –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ 3D –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ */
function getWorldPositionFromFingers(thumb, index, depth = -1.5) {
  const midX = (thumb.x + index.x) / 2;
  const midY = (thumb.y + index.y) / 2;
  
  const x = (midX - 0.5) * 2 * camera.position.z;
  const y = -(midY - 0.5) * 2 * camera.position.z;
  
  return { x, y, z: depth };
}

/* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è */
function handleDrawing(position, isStart) {
  if (isStart) {
    tubePoints = [new THREE.Vector3(position.x, position.y, position.z)];
    currentTube = null;
  } else if (tubePoints.length > 0) {
    const lastPoint = tubePoints[tubePoints.length - 1];
    const newPoint = new THREE.Vector3(position.x, position.y, position.z);
    
    if (lastPoint.distanceTo(newPoint) > 0.05) {
      tubePoints.push(newPoint);
      
      if (tubePoints.length >= 2) {
        if (currentTube) {
          scene.remove(currentTube);
        }
        
        currentTube = createTubeFromPoints(tubePoints, brushSettings.color, brushSettings.width);
        if (currentTube) {
          scene.add(currentTube);
        }
      }
    }
  }
}

function finishDrawing() {
  if (currentTube && tubePoints.length >= 2) {
    const obj = {
      mesh: currentTube,
      type: 'tube',
      name: `–õ–∏–Ω–∏—è ${objects.filter(o => o.type === 'tube').length + 1}`,
      id: Date.now() + Math.random()
    };
    
    objects.push(obj);
    setActive(obj);
    updateObjectsList();
  }
  
  currentTube = null;
  tubePoints = [];
}

/* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤ */
function handleObjectTransform(position, isStart) {
  if (isStart) {
    transformStart = {
      position: activeObject.mesh.position.clone(),
      rotation: activeObject.mesh.rotation.clone(),
      scale: activeObject.mesh.scale.x,
      handPos: position
    };
    smoothingSettings.smoothedPosition.copy(activeObject.mesh.position);
  } else if (transformStart) {
    const deltaX = position.x - transformStart.handPos.x;
    const deltaY = position.y - transformStart.handPos.y;
    
    switch(currentMode) {
      case 'movexy':
        const targetX = transformStart.position.x + deltaX * 2.5;
        const targetY = transformStart.position.y + deltaY * 2.5;
        
        smoothingSettings.smoothedPosition.x = exponentialSmoothingFast(
          targetX,
          smoothingSettings.smoothedPosition.x,
          smoothingSettings.positionSmoothness
        );
        smoothingSettings.smoothedPosition.y = exponentialSmoothingFast(
          targetY,
          smoothingSettings.smoothedPosition.y,
          smoothingSettings.positionSmoothness
        );
        
        activeObject.mesh.position.x = smoothingSettings.smoothedPosition.x;
        activeObject.mesh.position.y = smoothingSettings.smoothedPosition.y;
        break;
        
      case 'movez':
        const targetZ = transformStart.position.z + deltaY * 3.5;
        smoothingSettings.smoothedPosition.z = exponentialSmoothingFast(
          targetZ,
          smoothingSettings.smoothedPosition.z,
          smoothingSettings.positionSmoothness
        );
        activeObject.mesh.position.z = smoothingSettings.smoothedPosition.z;
        break;
        
      case 'rotate':
        activeObject.mesh.rotation.y = transformStart.rotation.y + deltaX * 3.5;
        activeObject.mesh.rotation.x = transformStart.rotation.x + deltaY * 3.5;
        break;
        
      case 'scale':
        const newScale = Math.max(0.1, transformStart.scale + deltaY * 3.5);
        activeObject.mesh.scale.setScalar(newScale);
        break;
    }
  }
}

/* –¶–∏–∫–ª —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä—É–∫ */
function startHandLoop() {
  function loop() {
    if (handLandmarker && video.readyState >= 2 && handDetectionActive) {
      try {
        const results = handLandmarker.detectForVideo(video, performance.now());
        if (results.landmarks && results.landmarks.length > 0) {
          handleHandLandmarks(results.landmarks);
        } else {
          // –ï—Å–ª–∏ —Ä—É–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, —Å–∫—Ä—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä
          pinchCursor.classList.remove('visible');
          handStatus.textContent = '–†—É–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞';
          handStatus.className = 'hand-not-detected';
        }
      } catch (err) {
        console.warn("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä—É–∫–∏:", err);
      }
    }
    requestAnimationFrame(loop);
  }
  loop();
}

/* –≠–ö–°–ü–û–†–¢ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô */
window.saveWithBackground = () => {
  const canvas = document.createElement("canvas");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext("2d");
  
  if (cameraEnabled && video.videoWidth > 0) {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  }
  
  ctx.drawImage(renderer.domElement, 0, 0);
  
  downloadCanvas(canvas, "scene-with-background.png");
};

window.saveTransparent = () => {
  downloadCanvas(renderer.domElement, "scene-transparent.png");
};

window.saveWithColorBg = () => {
  const canvas = document.createElement("canvas");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext("2d");
  
  ctx.fillStyle = backgroundColor;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  ctx.drawImage(renderer.domElement, 0, 0);
  
  downloadCanvas(canvas, "scene-colored-bg.png");
};

function downloadCanvas(canvasElement, filename) {
  const link = document.createElement("a");
  link.download = filename;
  link.href = canvasElement.toDataURL("image/png");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

/* –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –û–ö–ù–ê */
window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  Object.keys(modeZones).forEach(mode => updateZoneRect(mode));
});

/* –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø */
async function init() {
  await initCamera();
  await initHandDetection();
  
  initModeZones();
  setMode('movexy'); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º
  updateObjectsList();
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫—É—Ä—Å–æ—Ä –≤ —Ü–µ–Ω—Ç—Ä–µ —ç–∫—Ä–∞–Ω–∞
  updateCursorPosition(0.5, 0.5, 1);
  pinchCursor.classList.add('visible');
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
  function animate() {
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }
  animate();
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
init();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –≤ UI
document.getElementById("brushWidthValue").textContent = brushSettings.width.toFixed(2);
document.getElementById("smoothnessValue").textContent = smoothingSettings.positionSmoothness.toFixed(2);
</script>
</body>
</html>