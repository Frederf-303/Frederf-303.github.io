<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gesture Draw 2D</title>
<style>

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ –∫–ª–∏–∫–æ–≤ */
#clickModeIndicator {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(93, 220, 255, 0.9);
  backdrop-filter: blur(10px);
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  z-index: 1002;
  display: none;
  border: 2px solid rgba(255, 255, 255, 0.8);
  color: #000;
  box-shadow: 0 4px 20px rgba(93, 220, 255, 0.3);
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateX(-50%) translateY(20px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

/* PINCH CURSOR - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø */
#pinchCursor {
  position: fixed;
  width: 32px; /* –£–≤–µ–ª–∏—á–∏–º —Ä–∞–∑–º–µ—Ä */
  height: 32px; /* –£–≤–µ–ª–∏—á–∏–º —Ä–∞–∑–º–µ—Ä */
  border-radius: 50%;
  pointer-events: none;
  z-index: 1000;
  background: rgba(93, 220, 255, 0.95); /* –ú–µ–Ω—å—à–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ */
  box-shadow: 
    0 0 30px rgba(93, 220, 255, 0.9),
    0 0 60px rgba(93, 220, 255, 0.4),
    inset 0 0 0 3px rgba(255, 255, 255, 0.8); /* –ë–æ–ª–µ–µ —è—Ä–∫–∞—è –æ–±–≤–æ–¥–∫–∞ */
  transform: translate(-50%, -50%) scale(1);
  transition: 
    transform 0.15s,
    background 0.15s,
    box-shadow 0.15s,
    width 0.15s,
    height 0.15s;
  mix-blend-mode: difference; /* –ë—É–¥–µ—Ç –≤–∏–¥–µ–Ω –Ω–∞ –ª—é–±–æ–º —Ñ–æ–Ω–µ */
}

#pinchCursor.active {
  background: rgba(255, 80, 80, 0.95);
  box-shadow: 
    0 0 40px rgba(255, 80, 80, 0.9),
    0 0 80px rgba(255, 80, 80, 0.4),
    inset 0 0 0 3px rgba(255, 255, 255, 0.8);
  transform: translate(-50%, -50%) scale(1.5);
  width: 28px; /* –ù–µ–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ */
  height: 28px;
}

/* –î–ª—è —Ç—ë–º–Ω—ã—Ö —Ñ–æ–Ω–æ–≤ - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—É—Ä */
#pinchCursor::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  border-radius: 50%;
  border: 2px solid rgba(0, 0, 0, 0.3);
  z-index: -1;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è –∫—É–ª–∞–∫–∞ - —É–ª—É—á—à–µ–Ω–Ω—ã–π */
.cursor-fist {
  background: rgba(93, 220, 255, 0.95) !important;
  box-shadow: 
    0 0 50px rgba(93, 220, 255, 0.9),
    0 0 100px rgba(93, 220, 255, 0.3),
    inset 0 0 0 4px rgba(255, 255, 255, 0.9) !important;
  transform: translate(-50%, -50%) scale(1.5) !important;
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è –ª–∞—Å—Ç–∏–∫–∞ */
.cursor-eraser {
  background: rgba(255, 255, 255, 0.95) !important;
  box-shadow: 
    0 0 30px rgba(255, 255, 255, 0.9),
    0 0 60px rgba(255, 255, 255, 0.4),
    inset 0 0 0 3px rgba(0, 0, 0, 0.3) !important;
}
/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫—É–ª–∞–∫–∞ - —É–ª—É—á—à–µ–Ω–Ω—ã–π */
#fistIndicator {
  position: fixed;
  top: 50px;
  right: 20px;
  background: rgba(93, 220, 255, 0.15);
  backdrop-filter: blur(10px);
  padding: 10px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  z-index: 1002;
  display: none;
  border: 1px solid rgba(93, 220, 255, 0.3);
  color: var(--accent);
  box-shadow: 0 4px 12px rgba(93, 220, 255, 0.1);
  animation: fadeIn 0.3s ease-out;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è –∫—É–ª–∞–∫–∞ - —É–ª—É—á—à–µ–Ω–Ω—ã–π */
.cursor-fist {
  background: rgba(93, 220, 255, 0.6);
  box-shadow: 
    0 0 40px rgba(93, 220, 255, 0.8),
    inset 0 0 0 3px rgba(255, 255, 255, 0.5);
  transform: translate(-50%, -50%) scale(1.3);
}

/* –î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω–µ—Ü —Å—Ç–∏–ª–µ–π */
#sidebar {
  overflow-y: auto;
  overflow-x: hidden;
}

#sidebar::-webkit-scrollbar {
  width: 6px;
}

#sidebar::-webkit-scrollbar-track {
  background: var(--panel-light);
  border-radius: 3px;
}

#sidebar::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 3px;
}

/* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –Ω–µ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã */
.button-grid, .export-grid {
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

#pinchCursor {
  /* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫—É—Ä—Å–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω */
  will-change: transform;
  contain: layout style paint;
}

/* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫—É—Ä—Å–æ—Ä –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç—Å—è –¥—Ä—É–≥–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
#camera, #bgColorOverlay, #canvas {
  pointer-events: none;
}

#pinchCursor {
  pointer-events: none;
  z-index: 1001; /* –£–≤–µ–ª–∏—á—å—Ç–µ z-index */
}

.btn {
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}


:root {
  --bg: #0b0b10;
  --panel: rgba(20, 20, 27, 0.95);
  --panel-light: #2a2a3a;
  --border: #3a3a4a;
  --accent: #5ddcff;
  --accent-hover: #8ae9ff;
  --text: #ffffff;
  --text-secondary: #a0a0b0;
  --shadow: rgba(0, 0, 0, 0.3);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: var(--bg);
  font-family: 'Segoe UI', system-ui, sans-serif;
  color: var(--text);
}

/* CAMERA */
#camera {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  z-index: 0;
  transform: scaleX(1);
  transition: var(--transition);
  filter: brightness(0.9) contrast(1.1);
}

#camera.mirrored {
  transform: scaleX(-1);
}

#camera.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

/* BACKGROUND COLOR OVERLAY */
#bgColorOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 0;
  background-color: #0b0b10;
  transition: var(--transition);
  opacity: 0;
  pointer-events: none;
}

#bgColorOverlay.visible {
  opacity: 1;
}

/* CANVAS */
#canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 1;
  cursor: none;
}

/* SIDEBAR */
#sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: 280px;
  height: 100%;
  background: var(--panel);
  backdrop-filter: blur(10px);
  border-right: 1px solid var(--border);
  z-index: 2;
  display: flex;
  flex-direction: column;
  padding: 24px 20px;
  gap: 32px;
  transform: translateX(0);
  transition: var(--transition);
  box-shadow: 4px 0 20px var(--shadow);
}

#sidebar:hover {
  transform: translateX(0);
  box-shadow: 8px 0 30px var(--shadow);
}

#sidebar.hidden {
  transform: translateX(-100%);
}

/* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ - –ò–°–ü–†–ê–í–õ–ï–ù–û –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
#toggleSidebar {
  position: fixed;
  left: 10px;
  top: 10px;
  width: 48px;
  height: 48px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  cursor: pointer;
  z-index: 100; /* –í—ã—Å–æ–∫–∏–π z-index —á—Ç–æ–±—ã –±—ã—Ç—å –ø–æ–≤–µ—Ä—Ö –ø–∞–Ω–µ–ª–µ–π */
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 12px var(--shadow);
}

#toggleSidebar:hover {
  background: var(--panel-light);
  border-color: var(--accent);
  transform: scale(1.1);
  box-shadow: 0 6px 16px var(--shadow);
}

#toggleSidebar:active {
  transform: scale(0.95);
}

.section {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-secondary);
  margin-bottom: 4px;
  user-select: none;
}

.button-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.button-row {
  display: flex;
  gap: 10px;
}

.btn {
  background: var(--panel-light);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 12px 16px;
  border-radius: 12px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 14px;
  font-weight: 500;
  text-align: center;
  flex: 1;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn:hover {
  background: rgba(42, 42, 58, 0.8);
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px var(--shadow);
}

.btn.active {
  background: rgba(93, 220, 255, 0.15);
  border-color: var(--accent);
  color: var(--accent);
  box-shadow: 0 0 20px rgba(93, 220, 255, 0.2);
}

.btn-icon {
  font-size: 18px;
  line-height: 1;
}

.control-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.color-picker {
  width: 100%;
  height: 44px;
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  background: transparent;
  padding: 2px;
}

.color-picker::-webkit-color-swatch-wrapper {
  padding: 0;
}

.color-picker::-webkit-color-swatch {
  border: none;
  border-radius: 10px;
  min-height: 40px;
}

.slider-container {
  position: relative;
}

.slider-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 12px;
  color: var(--text-secondary);
}

.slider-value {
  color: var(--accent);
  font-weight: 600;
}

.slider {
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: var(--panel-light);
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid var(--panel);
  box-shadow: 0 2px 8px var(--shadow);
  transition: var(--transition);
}

.slider::-webkit-slider-thumb:hover {
  transform: scale(1.2);
  box-shadow: 0 4px 12px var(--shadow);
}

.toggle-group {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
}

.toggle-label {
  font-size: 14px;
  color: var(--text);
}

.toggle-btn {
  position: relative;
  width: 50px;
  height: 26px;
  background: var(--panel-light);
  border: 1px solid var(--border);
  border-radius: 13px;
  cursor: pointer;
  transition: var(--transition);
}

.toggle-btn::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: var(--text-secondary);
  border-radius: 50%;
  transition: var(--transition);
}

.toggle-btn.active {
  background: var(--accent);
  border-color: var(--accent);
}

.toggle-btn.active::after {
  left: calc(100% - 22px);
  background: var(--text);
}

.export-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.export-btn {
  background: linear-gradient(135deg, var(--panel-light), #2a2a3a);
  border: 1px solid var(--border);
  padding: 12px;
}

.export-btn:hover {
  background: linear-gradient(135deg, #3a3a4a, #2a2a3a);
  border-color: var(--accent);
}

/* PINCH CURSOR */
#pinchCursor {
  position: fixed;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  pointer-events: none;
  z-index: 1000;
  background: rgba(93, 220, 255, 0.95);
  box-shadow: 
    0 0 20px rgba(93, 220, 255, 0.8),
    inset 0 0 0 2px rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%) scale(1);
  transition: 
    transform 0.15s,
    background 0.15s,
    box-shadow 0.15s;
  mix-blend-mode: screen;
}

#pinchCursor.active {
  background: rgba(255, 80, 80, 0.95);
  box-shadow: 
    0 0 30px rgba(255, 80, 80, 0.9),
    inset 0 0 0 2px rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%) scale(1.5);
}

/* –ö—É—Ä—Å–æ—Ä –¥–ª—è –∫—É–ª–∞–∫–∞ */
.cursor-fist {
  background: rgba(93, 220, 255, 0.6);
  color: #5ddcff;
  box-shadow: 0 0 30px rgba(93, 220, 255, 0.8);
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫—É–ª–∞–∫–∞ */
#fistIndicator {
  position: fixed;
  top: 50px;
  right: 10px;
  background: rgba(93, 220, 255, 0.2);
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  z-index: 4;
  display: none;
  border: 1px solid rgba(93, 220, 255, 0.5);
}

/* STATUS BAR */
#statusBar {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--panel);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 24px;
  color: var(--text-secondary);
  font-size: 12px;
  z-index: 3;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: 0 4px 20px var(--shadow);
  transition: var(--transition);
  opacity: 0.9;
}

#statusBar:hover {
  opacity: 1;
  transform: translateX(-50%) translateY(-2px);
}

.status-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent);
}

.status-dot.recording {
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* RESPONSIVE */
@media (max-width: 768px) {
  #sidebar {
    width: 260px;
    padding: 20px 16px;
  }
  
  .button-grid {
    grid-template-columns: 1fr;
  }
  
  #statusBar {
    width: 90%;
    justify-content: center;
    padding: 10px 16px;
  }
}

/* UTILITY */
.hidden {
  display: none !important;
}

.fade-in {
  animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

<video id="camera" autoplay muted playsinline></video>
<div id="bgColorOverlay"></div>
<canvas id="canvas"></canvas>
<div id="pinchCursor"></div>
<div id="fistIndicator"></div>

<button id="toggleSidebar" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤">
  <span class="btn-icon">‚öôÔ∏è</span>
</button>
<div id="sidebar" class="fade-in">
  <!-- Navigation -->
  <div class="section">
    <div class="section-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
    <div class="button-row">
      <button class="btn" onclick="location.href='index.html'">
        <span class="btn-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è
      </button>
      <button class="btn" onclick="location.href='3D.html'">
        <span class="btn-icon">üî∫</span>3D
      </button>
    </div>
  </div>

  <!-- Tools -->
  <div class="section">
    <div class="section-title">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
    <div class="button-grid">
      <button class="btn active" onclick="setTool('pen')" id="tool-pen">
        <span class="btn-icon">üñåÔ∏è</span>–ö–∏—Å—Ç—å
      </button>
      <button class="btn" onclick="setTool('line')" id="tool-line">
        <span class="btn-icon">üìè</span>–û—Ç—Ä–µ–∑–æ–∫
      </button>
      <button class="btn" onclick="setTool('rect')" id="tool-rect">
        <span class="btn-icon">‚¨ú</span>–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
      </button>
      <button class="btn" onclick="setTool('circle')" id="tool-circle">
        <span class="btn-icon">‚≠ï</span>–ö—Ä—É–≥
      </button>
      <button class="btn" onclick="setTool('triangle')" id="tool-triangle">
        <span class="btn-icon">üî∫</span>–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫
      </button>
      <button class="btn" onclick="setTool('eraser')" id="tool-eraser">
        <span class="btn-icon">üßπ</span>–õ–∞—Å—Ç–∏–∫
      </button>
    </div>
  </div>

  <!-- Style -->
  <div class="section">
    <div class="section-title">–°—Ç–∏–ª—å</div>
    <div class="control-group">
      <input type="color" id="colorPicker" class="color-picker" value="#ff0000">
      
      <div class="slider-container">
        <div class="slider-label">
          <span>–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏</span>
          <span class="slider-value" id="widthValue">4px</span>
        </div>
        <input type="range" id="widthPicker" class="slider" min="1" max="30" value="4">
      </div>
      
      <div class="slider-container">
        <div class="slider-label">
          <span>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å</span>
          <span class="slider-value" id="opacityValue">100%</span>
        </div>
        <input type="range" id="opacityPicker" class="slider" min="10" max="100" value="100">
      </div>
    </div>
  </div>

  <!-- Camera Settings -->
  <div class="section">
    <div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã</div>
    <div class="control-group">
      <div class="button-row">
        <button class="btn" onclick="toggleCameraMirror()" id="mirrorBtn">
          <span class="btn-icon">üîÑ</span>–û—Ç–∑–µ—Ä–∫–∞–ª–∏—Ç—å
        </button>
        <button class="btn" onclick="toggleCamera()" id="cameraToggleBtn">
          <span class="btn-icon">üì∑</span>–í–∫–ª. –∫–∞–º–µ—Ä—É
        </button>
      </div>
      
      <div class="toggle-group">
        <span class="toggle-label">–¶–≤–µ—Ç–Ω–æ–π —Ñ–æ–Ω</span>
        <div class="toggle-btn" id="bgToggleBtn" onclick="toggleBackground()"></div>
      </div>
      
      <div id="colorControls">
        <div class="slider-label">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</div>
        <input type="color" id="bgColorPicker" class="color-picker" value="#0b0b10">
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="section">
    <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è</div>
    <div class="button-row">
      <button class="btn" onclick="undo()">
        <span class="btn-icon">‚Ü∂</span>–ù–∞–∑–∞–¥
      </button>
      <button class="btn" onclick="redo()">
        <span class="btn-icon">‚Ü∑</span>–í–ø–µ—Ä—ë–¥
      </button>
    </div>
  </div>

  <!-- Export -->
  <div class="section">
    <div class="section-title">–≠–∫—Å–ø–æ—Ä—Ç</div>
    <div class="export-grid">
      <button class="btn export-btn" onclick="saveTransparent()">
        <span class="btn-icon">üñºÔ∏è</span>PNG –±–µ–∑ —Ñ–æ–Ω–∞
      </button>
      <button class="btn export-btn" onclick="saveWithBackground()">
        <span class="btn-icon">üèûÔ∏è</span>PNG —Å —Ñ–æ–Ω–æ–º
      </button>
      <button class="btn export-btn" onclick="saveWithColorBackground()">
        <span class="btn-icon">üé®</span>PNG —Å —Ü–≤–µ—Ç–Ω—ã–º —Ñ–æ–Ω–æ–º
      </button>
      <button class="btn export-btn" onclick="importBackground()">
        <span class="btn-icon">üìÅ</span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω
      </button>
    </div>
  </div>
</div>
<div id="clickModeIndicator">–†–µ–∂–∏–º –∫–ª–∏–∫–æ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</div>
<!-- Status Bar -->
<div id="statusBar">
  <div class="status-item">
    <div class="status-dot recording"></div>
    <span>–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞</span>
  </div>
  <div class="status-item">
    <span>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: <span id="currentTool">–ö–∏—Å—Ç—å</span></span>
  </div>
  <div class="status-item">
    <span>–ò—Å—Ç–æ—Ä–∏—è: <span id="historyCount">0 –¥–µ–π—Å—Ç–≤–∏–π</span></span>
  </div>
</div>

<script type="module">
import { HandLandmarker, FilesetResolver }
from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8";

// ===== STATE =====
const state = {
  tool: "pen",
  color: "#ff0000",
  width: 4,
  opacity: 1,
  actions: [],
  redo: [],
  current: null,
  backgroundImage: null
};

// ===== CAMERA STATE =====
let isCameraEnabled = true;
let isCameraMirrored = false;
let isBackgroundEnabled = false;
let bgColor = "#0b0b10";

// ===== GESTURE STATE =====
let isFistDetected = false;
let wasFist = false;
let fistToggleCooldown = 0;
let panelsVisible = false;

// ===== UI ELEMENTS =====
const pinchCursor = document.getElementById("pinchCursor");
const sidebar = document.getElementById("sidebar");
const toggleSidebar = document.getElementById("toggleSidebar");
const currentToolElement = document.getElementById("currentTool");
const historyCountElement = document.getElementById("historyCount");
const fistIndicator = document.getElementById("fistIndicator");

// ===== CAMERA =====
const video = document.getElementById("camera");
let cameraInitialized = false;

async function initCamera() {
  try {
    video.srcObject = await navigator.mediaDevices.getUserMedia({ 
      video: { 
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: "user" 
      } 
    });
    
    // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
    await new Promise((resolve) => {
      video.onloadedmetadata = () => {
        video.play().then(() => {
          console.log('–ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞');
          cameraInitialized = true;
          resolve();
        }).catch(err => {
          console.warn('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:', err);
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          showCameraPermissionPrompt();
          resolve();
        });
      };
    });
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", error);
    showCameraError();
  }
}

function showCameraPermissionPrompt() {
  const prompt = document.createElement('div');
  prompt.id = 'cameraPrompt';
  prompt.innerHTML = `
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
      <div style="background: var(--panel); padding: 30px; border-radius: 15px; max-width: 400px; text-align: center;">
        <h3 style="margin-bottom: 15px; color: var(--accent);">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ</h3>
        <p style="margin-bottom: 20px;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∂–µ—Å—Ç–∞–º–∏.</p>
        <button id="enableCameraBtn" style="background: var(--accent); color: black; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">
          –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(prompt);
  
  document.getElementById('enableCameraBtn').addEventListener('click', async () => {
    try {
      await video.play();
      prompt.remove();
      cameraInitialized = true;
    } catch (err) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É:', err);
    }
  });
}

function showCameraError() {
  const error = document.createElement('div');
  error.innerHTML = `
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
      <div style="background: var(--panel); padding: 30px; border-radius: 15px; max-width: 400px; text-align: center;">
        <h3 style="margin-bottom: 15px; color: #ff5555;">–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã</h3>
        <p style="margin-bottom: 20px;">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.</p>
        <button onclick="location.reload()" style="background: var(--accent); color: black; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">
          –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(error);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
initCamera();

// ===== CANVAS =====
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");


// –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–Ω–≤–∞—Å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
function initCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  
  // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ñ–æ–Ω –∫–∞–Ω–≤–∞—Å–∞ –∫–∞–∫ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// –í—ã–∑–æ–≤–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
initCanvas();



// ===== SIDEBAR TOGGLE =====
let sidebarTimeout;


// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏
function toggleSidebarVisibility() {
  panelsVisible = !panelsVisible;
  
  if (panelsVisible) {
    sidebar.classList.remove('hidden');
    // –°–º–µ—â–∞–µ–º –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –ø–æ–≤–µ—Ä—Ö –ø–∞–Ω–µ–ª–∏
    toggleSidebar.style.left = '290px'; // –ü–∞–Ω–µ–ª—å 280px + –æ—Ç—Å—Ç—É–ø 10px
    toggleSidebar.innerHTML = '<span class="btn-icon">‚¨ÖÔ∏è</span>';
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–∫–æ–≤
    showClickModeIndicator();
  } else {
    sidebar.classList.add('hidden');
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
    toggleSidebar.style.left = '10px';
    toggleSidebar.innerHTML = '<span class="btn-icon">‚öôÔ∏è</span>';
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º—ã—à–∏
toggleSidebar.addEventListener('click', toggleSidebarVisibility);

sidebar.addEventListener('mouseenter', () => {
  clearTimeout(sidebarTimeout);
  sidebar.classList.remove('hidden');
  panelsVisible = true;
  toggleSidebar.style.left = '290px';
  toggleSidebar.innerHTML = '<span class="btn-icon">‚¨ÖÔ∏è</span>';
});

sidebar.addEventListener('mouseleave', () => {
  sidebarTimeout = setTimeout(() => {
    if (!sidebar.classList.contains('hidden')) {
      sidebar.classList.add('hidden');
      panelsVisible = false;
      toggleSidebar.style.left = '10px';
      toggleSidebar.innerHTML = '<span class="btn-icon">‚öôÔ∏è</span>';
    }
  }, 300);
});

// ===== TOOL FUNCTIONS =====
window.setTool = (tool) => {
  state.tool = tool;
  currentToolElement.textContent = getToolName(tool);
  
  // Update button states
  document.querySelectorAll('[id^="tool-"]').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById(`tool-${tool}`).classList.add('active');
  
  // Update cursor
  const cursor = document.getElementById('pinchCursor');
  cursor.classList.remove('cursor-eraser', 'cursor-fist');
  
  if (tool === 'eraser') {
    cursor.style.background = 'rgba(255, 255, 255, 0.95)';
    cursor.classList.add('cursor-eraser');
  } else {
    cursor.style.background = `rgba(${hexToRgb(state.color)}, 0.95)`;
  }
};

function getToolName(tool) {
  const names = {
    pen: '–ö–∏—Å—Ç—å',
    line: '–û—Ç—Ä–µ–∑–æ–∫',
    rect: '–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫',
    circle: '–ö—Ä—É–≥',
    triangle: '–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫',
    eraser: '–õ–∞—Å—Ç–∏–∫'
  };
  return names[tool] || tool;
}

// ===== COLOR & STYLE CONTROLS =====
document.getElementById('colorPicker').addEventListener('input', (e) => {
  state.color = e.target.value;
  if (state.tool !== 'eraser') {
    pinchCursor.style.background = `rgba(${hexToRgb(state.color)}, 0.95)`;
  }
});

document.getElementById('widthPicker').addEventListener('input', (e) => {
  state.width = +e.target.value;
  document.getElementById('widthValue').textContent = `${state.width}px`;
});

document.getElementById('opacityPicker').addEventListener('input', (e) => {
  state.opacity = +e.target.value / 100;
  document.getElementById('opacityValue').textContent = `${e.target.value}%`;
});

// ===== CAMERA CONTROLS =====
window.toggleCameraMirror = () => {
  isCameraMirrored = !isCameraMirrored;
  video.classList.toggle('mirrored', isCameraMirrored);
  document.getElementById('mirrorBtn').innerHTML = 
    isCameraMirrored 
      ? '<span class="btn-icon">üîÅ</span>–û–±—ã—á–Ω—ã–π –≤–∏–¥'
      : '<span class="btn-icon">üîÑ</span>–û—Ç–∑–µ—Ä–∫–∞–ª–∏—Ç—å';
};

window.toggleCamera = () => {
  isCameraEnabled = !isCameraEnabled;
  if (isCameraEnabled) {
    video.classList.remove('hidden');
    video.play();
    document.getElementById('cameraToggleBtn').innerHTML = 
      '<span class="btn-icon">üì∑</span>–í—ã–∫–ª. –∫–∞–º–µ—Ä—É';
  } else {
    video.classList.add('hidden');
    video.pause();
    document.getElementById('cameraToggleBtn').innerHTML = 
      '<span class="btn-icon">üì∑</span>–í–∫–ª. –∫–∞–º–µ—Ä—É';
  }
};

window.toggleBackground = () => {
  const toggleBtn = document.getElementById('bgToggleBtn');
  isBackgroundEnabled = !isBackgroundEnabled;
  toggleBtn.classList.toggle('active', isBackgroundEnabled);
  
  const bgOverlay = document.getElementById('bgColorOverlay');
  if (isBackgroundEnabled) {
    bgOverlay.classList.add('visible');
    bgOverlay.style.backgroundColor = bgColor;
  } else {
    bgOverlay.classList.remove('visible');
  }
};

document.getElementById('bgColorPicker').addEventListener('input', (e) => {
  bgColor = e.target.value;
  const bgOverlay = document.getElementById('bgColorOverlay');
  if (isBackgroundEnabled) {
    bgOverlay.style.backgroundColor = bgColor;
  }
});

// ===== DRAWING FUNCTIONS =====
function draw() {
  // Clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Draw background image if exists
  if (state.backgroundImage) {
    ctx.drawImage(state.backgroundImage, 0, 0, canvas.width, canvas.height);
  }
  
  // Draw all saved actions
  state.actions.forEach(action => drawAction(action));
  
  // Draw current action (preview)
  if (state.current) {
    drawAction(state.current, true);
  }
  
  // Update history count
  historyCountElement.textContent = `${state.actions.length} –¥–µ–π—Å—Ç–≤–∏–π`;
}

function drawAction(action, isPreview = false) {
  if (!action) return;
  
  ctx.save();
  
  // Set style
  const color = action.tool === 'eraser' 
    ? 'rgba(0, 0, 0, 0)' 
    : action.color;
    
  ctx.strokeStyle = color;
  ctx.fillStyle = color;
  ctx.lineWidth = action.width;
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.globalAlpha = isPreview ? 0.7 : action.opacity;
  
  if (action.tool === 'eraser') {
    ctx.globalCompositeOperation = 'destination-out';
  }
  
  if (action.type === "pen") {
    drawPen(action);
  } else if (action.type === "line") {
    drawLine(action);
  } else if (action.type === "rect") {
    drawRect(action);
  } else if (action.type === "circle") {
    drawCircle(action);
  } else if (action.type === "triangle") {
    drawTriangle(action);
  }
  
  ctx.restore();
}

function drawPen(action) {
  if (action.points.length < 2) return;
  
  ctx.beginPath();
  ctx.moveTo(action.points[0].x * canvas.width, action.points[0].y * canvas.height);
  
  // Smooth curve drawing
  for (let i = 1; i < action.points.length; i++) {
    const prev = action.points[i - 1];
    const curr = action.points[i];
    const midX = (prev.x + curr.x) / 2 * canvas.width;
    const midY = (prev.y + curr.y) / 2 * canvas.height;
    
    ctx.quadraticCurveTo(
      prev.x * canvas.width,
      prev.y * canvas.height,
      midX,
      midY
    );
  }
  
  ctx.stroke();
}

function drawLine(action) {
  ctx.beginPath();
  ctx.moveTo(action.start.x * canvas.width, action.start.y * canvas.height);
  ctx.lineTo(action.end.x * canvas.width, action.end.y * canvas.height);
  ctx.stroke();
}

function drawRect(action) {
  const x = Math.min(action.start.x, action.end.x) * canvas.width;
  const y = Math.min(action.start.y, action.end.y) * canvas.height;
  const w = Math.abs(action.end.x - action.start.x) * canvas.width;
  const h = Math.abs(action.end.y - action.start.y) * canvas.height;
  
  ctx.beginPath();
  ctx.rect(x, y, w, h);
  ctx.stroke();
}

function drawCircle(action) {
  const cx = (action.start.x + action.end.x) / 2 * canvas.width;
  const cy = (action.start.y + action.end.y) / 2 * canvas.height;
  const radius = Math.hypot(
    action.end.x - action.start.x,
    action.end.y - action.start.y
  ) * canvas.width / 2;
  
  ctx.beginPath();
  ctx.arc(cx, cy, radius, 0, Math.PI * 2);
  ctx.stroke();
}

function drawTriangle(action) {
  const x1 = action.start.x * canvas.width;
  const y1 = action.start.y * canvas.height;
  const x2 = action.end.x * canvas.width;
  const y2 = action.end.y * canvas.height;
  
  ctx.beginPath();
  ctx.moveTo(x1, y2);
  ctx.lineTo((x1 + x2) / 2, y1);
  ctx.lineTo(x2, y2);
  ctx.closePath();
  ctx.stroke();
}

// ===== GESTURE RECOGNITION =====
const vision = await FilesetResolver.forVisionTasks(
  "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/wasm"
);

const hand = await HandLandmarker.createFromOptions(vision, {
  baseOptions: { 
    modelAssetPath: "https://storage.googleapis.com/mediapipe-assets/hand_landmarker.task" 
  },
  runningMode: "VIDEO",
  numHands: 1
});

const PINCH_THRESHOLD = 0.08;
let drawing = false;
let lastPoint = null;
const SMOOTHING_FACTOR = 0.4;

/* –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É–ª–∞–∫–∞ */
/* –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É–ª–∞–∫–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø */
function isFistGesture(landmarks) {
  if (!landmarks || landmarks.length === 0 || landmarks.length < 21) {
    console.log('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ landmarks:', landmarks?.length || 0);
    return false;
  }
  
  const lm = landmarks; // landmarks —É–∂–µ –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–æ—á–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
  if (!lm[0] || !lm[4] || !lm[8] || !lm[12] || !lm[16] || !lm[20]) {
    console.log('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–æ—á–∫–∏ —Ä—É–∫–∏');
    return false;
  }
  
  // –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏
  const wrist = lm[0];       // –ó–∞–ø—è—Å—Ç—å–µ (0)
  const thumbTip = lm[4];    // –ö–æ–Ω—á–∏–∫ –±–æ–ª—å—à–æ–≥–æ –ø–∞–ª—å—Ü–∞ (4)
  const indexTip = lm[8];    // –ö–æ–Ω—á–∏–∫ —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞–ª—å—Ü–∞ (8)
  const middleTip = lm[12];  // –ö–æ–Ω—á–∏–∫ —Å—Ä–µ–¥–Ω–µ–≥–æ –ø–∞–ª—å—Ü–∞ (12)
  const ringTip = lm[16];    // –ö–æ–Ω—á–∏–∫ –±–µ–∑—ã–º—è–Ω–Ω–æ–≥–æ –ø–∞–ª—å—Ü–∞ (16)
  const pinkyTip = lm[20];   // –ö–æ–Ω—á–∏–∫ –º–∏–∑–∏–Ω—Ü–∞ (20)
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ—á–∫–∏ –∏–º–µ—é—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
  if (!wrist.x || !wrist.y || !thumbTip.x || !thumbTip.y) {
    console.log('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫');
    return false;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∂–∞—Ç—ã –ª–∏ –ø–∞–ª—å—Ü—ã (–∫–æ–Ω—á–∏–∫–∏ –±–ª–∏–∑–∫–æ –∫ –∑–∞–ø—è—Å—Ç—å—é)
  const maxFistDistance = 0.15; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∫—É–ª–∞–∫–∞
  
  const thumbDistance = Math.hypot(thumbTip.x - wrist.x, thumbTip.y - wrist.y);
  const indexDistance = Math.hypot(indexTip.x - wrist.x, indexTip.y - wrist.y);
  const middleDistance = Math.hypot(middleTip.x - wrist.x, middleTip.y - wrist.y);
  const ringDistance = Math.hypot(ringTip.x - wrist.x, ringTip.y - wrist.y);
  const pinkyDistance = Math.hypot(pinkyTip.x - wrist.x, pinkyTip.y - wrist.y);
  
  // –ö—É–ª–∞–∫, –∫–æ–≥–¥–∞ –≤—Å–µ –ø–∞–ª—å—Ü—ã –±–ª–∏–∑–∫–æ –∫ –∑–∞–ø—è—Å—Ç—å—é
  const isFist = thumbDistance < maxFistDistance &&
                 indexDistance < maxFistDistance &&
                 middleDistance < maxFistDistance &&
                 ringDistance < maxFistDistance &&
                 pinkyDistance < maxFistDistance;
  
  // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
  if (isFist) {
    console.log('–ö—É–ª–∞–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω! –†–∞—Å—Å—Ç–æ—è–Ω–∏—è:', {
      thumb: thumbDistance.toFixed(3),
      index: indexDistance.toFixed(3),
      middle: middleDistance.toFixed(3),
      ring: ringDistance.toFixed(3),
      pinky: pinkyDistance.toFixed(3)
    });
  }
  
  return isFist;
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –ø–æ –∂–µ—Å—Ç—É –∫—É–ª–∞–∫–∞ */
/* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –ø–æ –∂–µ—Å—Ç—É –∫—É–ª–∞–∫–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø */
function updatePanelsForFist(isFistNow) {
  // –ï—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
  if (isFistNow === undefined || isFistNow === null) {
    return;
  }
  
  // –ö—É–ª–∞–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –≤–ø–µ—Ä–≤—ã–µ - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –ø–∞–Ω–µ–ª–∏
  if (isFistNow && !wasFist && fistToggleCooldown <= 0) {
    console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–µ–π –∂–µ—Å—Ç–æ–º –∫—É–ª–∞–∫–∞');
    toggleSidebarVisibility();
    wasFist = true;
    fistToggleCooldown = 30; // 30 –∫–∞–¥—Ä–æ–≤ –∑–∞–¥–µ—Ä–∂–∫–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ 0.5 —Å–µ–∫)
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    fistIndicator.textContent = panelsVisible ? '–ü–∞–Ω–µ–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã' : '–ü–∞–Ω–µ–ª–∏ –∑–∞–∫—Ä—ã—Ç—ã';
    fistIndicator.style.display = 'block';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä –¥–ª—è –∫—É–ª–∞–∫–∞
    pinchCursor.classList.add('cursor-fist');
    pinchCursor.style.background = 'rgba(93, 220, 255, 0.6)';
    pinchCursor.style.boxShadow = '0 0 30px rgba(93, 220, 255, 0.8)';
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
      fistIndicator.style.display = 'none';
    }, 2000);
  } 
  // –ö—É–ª–∞–∫ —Ä–∞–∑–∂–∞—Ç
  else if (!isFistNow && wasFist) {
    wasFist = false;
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –∫—É—Ä—Å–æ—Ä–∞
    if (state.tool === 'eraser') {
      pinchCursor.style.background = 'rgba(255, 255, 255, 0.95)';
    } else {
      pinchCursor.style.background = `rgba(${hexToRgb(state.color)}, 0.95)`;
    }
    pinchCursor.style.boxShadow = '0 0 20px rgba(93, 220, 255, 0.8)';
    pinchCursor.classList.remove('cursor-fist');
  }
  
  // –£–º–µ–Ω—å—à–∞–µ–º –∫–¥
  if (fistToggleCooldown > 0) {
    fistToggleCooldown--;
  }
}

function handleHand(landmarks) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ landmarks —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫
  if (!landmarks || landmarks.length < 21) {
    console.log('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ landmarks –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫:', landmarks?.length || 0);
    pinchCursor.style.display = 'none';
    return;
  }
  
  pinchCursor.style.display = 'block';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è —â–µ–ø–∫–∞
  const thumb = landmarks[4];
  const index = landmarks[8];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–æ—á–µ–∫
  if (!thumb || !index || !thumb.x || !thumb.y || !index.x || !index.y) {
    console.log('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–æ—á–∫–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —â–µ–ø–∫–∞');
    return;
  }
  
  const pinchDistance = Math.hypot(
    thumb.x - index.x,
    thumb.y - index.y
  );
  
  const isPinching = pinchDistance < PINCH_THRESHOLD;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∂–µ—Å—Ç –∫—É–ª–∞–∫–∞ (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ—à–∏–±–æ–∫)
  let isFistNow = false;
  try {
    isFistNow = isFistGesture(landmarks);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∫—É–ª–∞–∫–∞:', error);
    isFistNow = false;
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª–∏ –¥–ª—è –∫—É–ª–∞–∫–∞
  updatePanelsForFist(isFistNow);
  
  // –ï—Å–ª–∏ –∫—É–ª–∞–∫ - –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥—Ä—É–≥–∏—Ö –∂–µ—Å—Ç–æ–≤
  if (isFistNow) {
    // –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–ª–∏–∫–æ–≤
    if (isPotentialClick) {
      isPotentialClick = false;
      if (potentialClickElement) {
        highlightElement(potentialClickElement, false);
        potentialClickElement = null;
      }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ –¥–ª—è –∫—É–ª–∞–∫–∞
    const cursorX = (thumb.x + index.x) / 2;
    const cursorY = (thumb.y + index.y) / 2;
    
    // –°–≥–ª–∞–∂–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
    const rawPoint = {
      x: cursorX,
      y: cursorY
    };
    
    if (lastPoint) {
      rawPoint.x = lastPoint.x * (1 - SMOOTHING_FACTOR) + rawPoint.x * SMOOTHING_FACTOR;
      rawPoint.y = lastPoint.y * (1 - SMOOTHING_FACTOR) + rawPoint.y * SMOOTHING_FACTOR;
    }
    lastPoint = { x: rawPoint.x, y: rawPoint.y };
    
    updateCursor(rawPoint, false);
    return;
  }
  
  // Calculate draw point (midpoint between thumb and index)
  const rawPoint = {
    x: (thumb.x + index.x) / 2,
    y: (thumb.y + index.y) / 2
  };
  
  // Smooth point movement
  if (lastPoint) {
    rawPoint.x = lastPoint.x * (1 - SMOOTHING_FACTOR) + rawPoint.x * SMOOTHING_FACTOR;
    rawPoint.y = lastPoint.y * (1 - SMOOTHING_FACTOR) + rawPoint.y * SMOOTHING_FACTOR;
  }
  lastPoint = { x: rawPoint.x, y: rawPoint.y };
  
  // Update cursor
  updateCursor(rawPoint, isPinching);
  
  // –ï—Å–ª–∏ –ø–∞–Ω–µ–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–ª–∏–∫–∞
  if (panelsVisible) {
    handleUIClickDetection(rawPoint, isPinching);
  }
  
  // Handle drawing (—Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π –∏–ª–∏ –Ω–µ –¥–µ–ª–∞–µ–º –∫–ª–∏–∫)
  if (!isPotentialClick || !panelsVisible) {
    handleDrawing(rawPoint, isPinching);
  }
}

function updateCursor(point, isPinching) {
  pinchCursor.style.left = point.x * window.innerWidth + "px";
  pinchCursor.style.top = point.y * window.innerHeight + "px";
  pinchCursor.classList.toggle("active", isPinching);
}

function handleDrawing(point, isPinching) {
  // Start drawing
  if (isPinching && !drawing) {
    drawing = true;
    
    if (state.tool === "pen") {
      state.current = {
        type: "pen",
        tool: state.tool,
        color: state.color,
        width: state.width,
        opacity: state.opacity,
        points: [point]
      };
    } else {
      state.current = {
        type: state.tool,
        tool: state.tool,
        color: state.tool === 'eraser' ? null : state.color,
        width: state.width,
        opacity: state.opacity,
        start: { x: point.x, y: point.y }, // –ö–æ–ø–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç
        end: { x: point.x, y: point.y }    // –ö–æ–ø–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç
      };
    }
    console.log('–ù–∞—á–∞–ª–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è:', state.current.type);
    return;
  }
  
  // Update drawing
  if (isPinching && drawing && state.current) {
    if (state.current.type === "pen") {
      state.current.points.push({ x: point.x, y: point.y }); // –ö–æ–ø–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç
    } else {
      state.current.end = { x: point.x, y: point.y }; // –ö–æ–ø–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç
    }
  }
  
  // End drawing
  if (!isPinching && drawing && state.current) {
    drawing = false;
    
    // Check if drawing has meaningful size
    const hasSize = checkDrawingSize(state.current);
    if (hasSize) {
      // –ì–ª—É–±–æ–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
      const actionCopy = JSON.parse(JSON.stringify(state.current));
      state.actions.push(actionCopy);
      state.redo = []; // Clear redo stack on new action
      console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ:', state.current.type);
    } else {
      console.log('–î–µ–π—Å—Ç–≤–∏–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ, –æ—Ç–º–µ–Ω–µ–Ω–æ');
    }
    
    state.current = null;
  }
}

function checkDrawingSize(action) {
  if (action.type === "pen") {
    return action.points.length > 2; // –ë—ã–ª–æ > 1, —Å—Ç–∞–ª–æ > 2
  } else {
    const dx = action.end.x - action.start.x;
    const dy = action.end.y - action.start.y;
    const size = Math.hypot(dx, dy);
    return size > 0.02; // –ë—ã–ª–æ > 0.01, —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ª—É—á—à–µ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  }
}

// ===== ANIMATION LOOP =====
function loop() {
  if (video.readyState >= 2) {
    const results = hand.detectForVideo(video, performance.now());
    if (results.landmarks && results.landmarks.length > 0) {
      handleHand(results.landmarks[0]);
    }
  }
  draw();
  requestAnimationFrame(loop);
}
loop();

// ===== HISTORY =====
window.undo = () => {
  if (state.actions.length > 0) {
    state.redo.push(state.actions.pop());
  }
};

window.redo = () => {
  if (state.redo.length > 0) {
    state.actions.push(state.redo.pop());
  }
};

// ===== EXPORT FUNCTIONS =====
window.saveTransparent = () => {
  const exportCanvas = document.createElement("canvas");
  exportCanvas.width = canvas.width;
  exportCanvas.height = canvas.height;
  const exportCtx = exportCanvas.getContext("2d");
  
  // Draw only the drawing (transparent background)
  state.actions.forEach(action => {
    const tempCtx = exportCanvas.getContext("2d");
    drawActionOnCanvas(action, tempCtx, exportCanvas);
  });
  
  downloadImage(exportCanvas, "drawing-transparent.png");
};

window.saveWithBackground = () => {
  const exportCanvas = document.createElement("canvas");
  exportCanvas.width = canvas.width;
  exportCanvas.height = canvas.height;
  const exportCtx = exportCanvas.getContext("2d");
  
  // Draw background
  if (isCameraEnabled && !isBackgroundEnabled && !state.backgroundImage) {
    exportCtx.drawImage(video, 0, 0, exportCanvas.width, exportCanvas.height);
  } else if (isBackgroundEnabled) {
    exportCtx.fillStyle = bgColor;
    exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
  } else if (state.backgroundImage) {
    exportCtx.drawImage(state.backgroundImage, 0, 0, exportCanvas.width, exportCanvas.height);
  } else {
    exportCtx.fillStyle = "#000000";
    exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
  }
  
  // Draw drawing
  state.actions.forEach(action => {
    drawActionOnCanvas(action, exportCtx, exportCanvas);
  });
  
  downloadImage(exportCanvas, "drawing-with-background.png");
};

window.saveWithColorBackground = () => {
  const exportCanvas = document.createElement("canvas");
  exportCanvas.width = canvas.width;
  exportCanvas.height = canvas.height;
  const exportCtx = exportCanvas.getContext("2d");
  
  exportCtx.fillStyle = bgColor;
  exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
  
  state.actions.forEach(action => {
    drawActionOnCanvas(action, exportCtx, exportCanvas);
  });
  
  const colorName = bgColor.replace('#', '');
  downloadImage(exportCanvas, `drawing-${colorName}.png`);
};

function drawActionOnCanvas(action, context, targetCanvas) {
  const originalCanvas = canvas;
  const originalCtx = ctx;
  
  canvas = targetCanvas;
  ctx = context;
  
  drawAction(action);
  
  canvas = originalCanvas;
  ctx = originalCtx;
}

function downloadImage(canvas, filename) {
  const link = document.createElement("a");
  link.download = filename;
  link.href = canvas.toDataURL("image/png");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ===== BACKGROUND IMPORT =====
window.importBackground = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        state.backgroundImage = img;
        // Disable camera and color background when using image
        isCameraEnabled = false;
        isBackgroundEnabled = false;
        video.classList.add('hidden');
        document.getElementById('bgToggleBtn').classList.remove('active');
        document.getElementById('cameraToggleBtn').innerHTML = 
          '<span class="btn-icon">üì∑</span>–í–∫–ª. –∫–∞–º–µ—Ä—É';
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  };
  
  input.click();
};

// ===== UTILITY FUNCTIONS =====
function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? 
    `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` 
    : '255, 0, 0';
}

// ===== RESIZE HANDLING =====
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  draw();
}

window.addEventListener("resize", resize);
resize();

// Initialize tool
setTool('pen');

// ===== CLICK DETECTION STATE =====
let clickStartTime = 0;
let isPotentialClick = false;
let potentialClickElement = null;
const CLICK_TIME_THRESHOLD = 500; // 0.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∫–ª–∏–∫–∞
const CLICK_DISTANCE_THRESHOLD = 0.05; // 5% –æ—Ç —ç–∫—Ä–∞–Ω–∞

// ===== ELEMENT DETECTION =====
function getElementAtPoint(x, y) {
  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∂–µ—Å—Ç–∞ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —ç–∫—Ä–∞–Ω–∞
  const screenX = x * window.innerWidth;
  const screenY = y * window.innerHeight;
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º document.elementFromPoint –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
  return document.elementFromPoint(screenX, screenY);
}

function isClickableElement(element) {
  if (!element) return false;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º
  const clickableTags = ['BUTTON', 'A', 'INPUT[type="button"]', 'INPUT[type="submit"]'];
  const clickableClasses = ['btn', 'color-picker', 'slider', 'toggle-btn'];
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç–µ–≥—É
  if (clickableTags.includes(element.tagName)) {
    return true;
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∫–ª–∞—Å—Å–∞–º
  for (const className of clickableClasses) {
    if (element.classList.contains(className)) {
      return true;
    }
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  let parent = element.parentElement;
  while (parent) {
    if (parent.classList && Array.from(parent.classList).some(c => clickableClasses.includes(c))) {
      return true;
    }
    parent = parent.parentElement;
  }
  
  return false;
}

function highlightElement(element, highlight = true) {
  if (!element) return;
  
  // –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –∫–Ω–æ–ø–∫—É (–º–æ–∂–µ—Ç –±—ã—Ç—å span –≤–Ω—É—Ç—Ä–∏ button)
  let clickableElement = element;
  if (!isClickableElement(element)) {
    clickableElement = element.closest('.btn, .color-picker, .slider, .toggle-btn');
  }
  
  if (!clickableElement) return;
  
  if (highlight) {
    clickableElement.style.outline = '3px solid #5ddcff';
    clickableElement.style.outlineOffset = '2px';
    clickableElement.style.boxShadow = '0 0 20px rgba(93, 220, 255, 0.5)';
    clickableElement.style.transition = 'all 0.2s ease';
  } else {
    clickableElement.style.outline = '';
    clickableElement.style.outlineOffset = '';
    clickableElement.style.boxShadow = '';
  }
}

function handleElementClick(element) {
  if (!element) return;
  
  console.log('–ö–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É:', element);
  
  // –ù–∞—Ö–æ–¥–∏–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –∫–Ω–æ–ø–∫—É
  let clickableElement = element;
  if (!isClickableElement(element)) {
    clickableElement = element.closest('.btn, .color-picker, .slider, .toggle-btn');
  }
  
  if (!clickableElement) return;
  
  // –ò–º–∏—Ç–∏—Ä—É–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –∫–ª–∏–∫–æ–≤
  if (clickableElement.tagName === 'BUTTON') {
    // –í—ã–∑—ã–≤–∞–µ–º –∫–ª–∏–∫
    clickableElement.click();
    
    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
    const originalBackground = clickableElement.style.background;
    clickableElement.style.background = 'rgba(93, 220, 255, 0.3)';
    
    setTimeout(() => {
      clickableElement.style.background = originalBackground;
    }, 200);
    
  } else if (clickableElement.type === 'range') {
    // –î–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ - –º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–∏
    const rect = clickableElement.getBoundingClientRect();
    const x = (lastPoint.x * window.innerWidth - rect.left) / rect.width;
    const value = Math.min(Math.max(x, 0), 1);
    const min = parseFloat(clickableElement.min) || 0;
    const max = parseFloat(clickableElement.max) || 100;
    
    const newValue = min + value * (max - min);
    clickableElement.value = newValue;
    clickableElement.dispatchEvent(new Event('input'));
    clickableElement.dispatchEvent(new Event('change'));
    
  } else if (clickableElement.type === 'color') {
    // –î–ª—è —Ü–≤–µ—Ç–æ–≤—ã—Ö –ø–∏–∫–µ—Ä–æ–≤ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–ª–∏—Ç—Ä—É
    clickableElement.click();
  }
  
  // –ó–≤—É–∫–æ–≤–æ–π –∏–ª–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±—ç–∫
  showClickFeedback(clickableElement);
}

function showClickFeedback(element) {
  // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –∫–ª–∏–∫–∞
  const rect = element.getBoundingClientRect();
  const feedback = document.createElement('div');
  feedback.style.position = 'fixed';
  feedback.style.left = rect.left + rect.width / 2 + 'px';
  feedback.style.top = rect.top + rect.height / 2 + 'px';
  feedback.style.width = '50px';
  feedback.style.height = '50px';
  feedback.style.borderRadius = '50%';
  feedback.style.background = 'radial-gradient(circle, rgba(93, 220, 255, 0.5) 0%, transparent 70%)';
  feedback.style.zIndex = '1001';
  feedback.style.pointerEvents = 'none';
  feedback.style.transform = 'translate(-50%, -50%) scale(0)';
  feedback.style.animation = 'clickFeedback 0.3s ease-out';
  
  document.body.appendChild(feedback);
  
  // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 0.3 —Å–µ–∫—É–Ω–¥—ã
  setTimeout(() => {
    feedback.remove();
  }, 300);
}

// –î–æ–±–∞–≤—å—Ç–µ –≤ CSS –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —Ñ–∏–¥–±—ç–∫–∞
const style = document.createElement('style');
style.textContent = `
@keyframes clickFeedback {
  0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
}
`;
document.head.appendChild(style);

// ===== UI CLICK DETECTION =====
function handleUIClickDetection(point, isPinching) {
  const element = getElementAtPoint(point.x, point.y);
  
  // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π
  if (isClickableElement(element)) {
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
    if (potentialClickElement !== element) {
      if (potentialClickElement) {
        highlightElement(potentialClickElement, false);
      }
      potentialClickElement = element;
      highlightElement(element, true);
    }
    
    // –ù–∞—á–∞–ª–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–∫–∞
    if (isPinching && !isPotentialClick) {
      isPotentialClick = true;
      clickStartTime = Date.now();
      console.log('–ù–∞—á–∞–ª–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –Ω–∞:', element);
    }
    
    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–ª–∏–∫–∞ (–æ—Ç–ø—É—Å—Ç–∏–ª–∏ —â–µ–ø–æ–∫)
    if (!isPinching && isPotentialClick) {
      const clickDuration = Date.now() - clickStartTime;
      
      // –ï—Å–ª–∏ —â–µ–ø–æ–∫ –±—ã–ª –∫–æ—Ä–æ—Ç–∫–∏–π - —ç—Ç–æ –∫–ª–∏–∫
      if (clickDuration < CLICK_TIME_THRESHOLD) {
        handleElementClick(element);
      }
      
      isPotentialClick = false;
      clickStartTime = 0;
    }
  } else {
    // –ï—Å–ª–∏ –∫—É—Ä—Å–æ—Ä –Ω–µ –Ω–∞–¥ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
    if (potentialClickElement) {
      highlightElement(potentialClickElement, false);
      potentialClickElement = null;
    }
    
    if (isPinching && isPotentialClick) {
      // –©–µ–ø–æ–∫ –Ω–∞—á–∞–ª—Å—è –Ω–∞–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–º, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏–ª—Å—è –≤–Ω–µ –µ–≥–æ - –æ—Ç–º–µ–Ω—è–µ–º –∫–ª–∏–∫
      isPotentialClick = false;
      clickStartTime = 0;
    }
  }
  
  // –ï—Å–ª–∏ —â–µ–ø–æ–∫ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–π - —ç—Ç–æ –Ω–µ –∫–ª–∏–∫, –∞ –≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞—á–∞–ª–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
  if (isPinching && isPotentialClick) {
    const clickDuration = Date.now() - clickStartTime;
    if (clickDuration > CLICK_TIME_THRESHOLD) {
      isPotentialClick = false;
      console.log('–°–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–π —â–µ–ø–æ–∫ - –Ω–µ –∫–ª–∏–∫');
    }
  }
}

// ===== MODIFIED SETTOOL FUNCTION =====
// –û–±–Ω–æ–≤–∏—Ç–µ setTool –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞
window.setTool = (tool) => {
  state.tool = tool;
  currentToolElement.textContent = getToolName(tool);
  
  // Update button states
  document.querySelectorAll('[id^="tool-"]').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById(`tool-${tool}`).classList.add('active');
  
  // Update cursor
  const cursor = document.getElementById('pinchCursor');
  cursor.classList.remove('cursor-eraser', 'cursor-fist');
  
  if (tool === 'eraser') {
    cursor.style.background = 'rgba(255, 255, 255, 0.95)';
    cursor.classList.add('cursor-eraser');
  } else {
    cursor.style.background = `rgba(${hexToRgb(state.color)}, 0.95)`;
  }
};

// ===== INITIALIZATION =====
// –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –≤ –∫–æ–Ω–µ—Ü —Å–∫—Ä–∏–ø—Ç–∞
console.log('–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–ª–∏–∫–æ–≤ –∂–µ—Å—Ç–∞–º–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

// –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–Ω–µ–ª—å –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞
sidebar.classList.add('hidden');
panelsVisible = false;

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–∞–Ω–µ–ª–∏
function showClickModeIndicator() {
  const indicator = document.getElementById('clickModeIndicator');
  if (!indicator) return;
  
  indicator.style.display = 'block';
  indicator.textContent = '–†–µ–∂–∏–º –∫–ª–∏–∫–æ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω';
  
  // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
  setTimeout(() => {
    indicator.style.display = 'none';
  }, 3000);
}

// –í—ã–∑—ã–≤–∞–π—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–∞–Ω–µ–ª–∏
// –í —Ñ—É–Ω–∫—Ü–∏–∏ toggleSidebarVisibility –¥–æ–±–∞–≤—å—Ç–µ:
if (panelsVisible) {
  showClickModeIndicator();
}

</script>
</body>
</html>